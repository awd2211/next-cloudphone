{
  "info": {
    "name": "API Gateway - Permissions Test",
    "description": "æµ‹è¯• API Gateway çš„æƒé™ç›¸å…³æ¥å£",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:30000/api"
    },
    {
      "key": "token",
      "value": ""
    },
    {
      "key": "captchaId",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "0. è·å–éªŒè¯ç ",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Captcha received', function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('id');",
              "    pm.expect(jsonData).to.have.property('image');",
              "    pm.collectionVariables.set('captchaId', jsonData.id);",
              "    console.log('âœ… éªŒè¯ç  ID:', jsonData.id);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/auth/captcha",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "captcha"]
        }
      },
      "response": []
    },
    {
      "name": "1. ç”¨æˆ·ç™»å½•ï¼ˆå¸¦éªŒè¯ç ï¼‰",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const jsonData = pm.response.json();",
              "",
              "// å¦‚æœæ˜¯éªŒè¯ç é”™è¯¯ï¼Œè·³è¿‡å¹¶æç¤º",
              "if (pm.response.code === 400 && jsonData.message && jsonData.message.includes('éªŒè¯ç ')) {",
              "    console.log('âš ï¸ éªŒè¯ç éªŒè¯å¤±è´¥ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å®é™…éªŒè¯ç ï¼‰');",
              "    console.log('ğŸ’¡ è¯·ä½¿ç”¨çœŸå®éªŒè¯ç æˆ–ç¦ç”¨éªŒè¯ç éªŒè¯');",
              "    return;",
              "}",
              "",
              "pm.test('Status code is 200 or 400', function () {",
              "    pm.expect([200, 400]).to.include(pm.response.code);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    pm.test('Response has token', function () {",
              "        pm.expect(jsonData).to.have.property('access_token');",
              "        pm.collectionVariables.set('token', jsonData.access_token);",
              "        console.log('âœ… Token saved:', jsonData.access_token.substring(0, 20) + '...');",
              "    });",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"admin123\",\n  \"captcha\": \"0000\",\n  \"captchaId\": \"{{captchaId}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "login"]
        }
      },
      "response": []
    },
    {
      "name": "2. ç›´æ¥æµ‹è¯• User Service - æ•°æ®èŒƒå›´ï¼ˆæ— è®¤è¯ï¼‰",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Direct access returns data', function () {",
              "    const jsonData = pm.response.json();",
              "    console.log('ğŸ“Š ç›´æ¥è®¿é—® User Service - æ•°æ®èŒƒå›´é…ç½®æ•°é‡:', jsonData.total);",
              "    console.log('ğŸ“ æ•°æ®åˆ—è¡¨é•¿åº¦:', jsonData.data.length);",
              "    pm.expect(jsonData.total).to.equal(12);",
              "    pm.expect(jsonData.data).to.be.an('array').with.lengthOf(12);",
              "    ",
              "    if (jsonData.data.length > 0) {",
              "        console.log('âœ… ç¬¬ä¸€æ¡æ•°æ®:', JSON.stringify(jsonData.data[0], null, 2));",
              "    }",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:30001/data-scopes?isActive=true",
          "protocol": "http",
          "host": ["localhost"],
          "port": "30001",
          "path": ["data-scopes"],
          "query": [
            {
              "key": "isActive",
              "value": "true"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "3. ç›´æ¥æµ‹è¯• User Service - å­—æ®µæƒé™ï¼ˆæ— è®¤è¯ï¼‰",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Field permissions data', function () {",
              "    const jsonData = pm.response.json();",
              "    console.log('ğŸ“Š ç›´æ¥è®¿é—® User Service - å­—æ®µæƒé™é…ç½®æ•°é‡:', jsonData.total);",
              "    console.log('ğŸ“ æ•°æ®åˆ—è¡¨é•¿åº¦:', jsonData.data.length);",
              "    pm.expect(jsonData).to.have.property('success', true);",
              "    pm.expect(jsonData.data).to.be.an('array').with.lengthOf(5);",
              "    ",
              "    if (jsonData.data.length > 0) {",
              "        console.log('âœ… ç¬¬ä¸€æ¡æ•°æ®:', JSON.stringify(jsonData.data[0], null, 2));",
              "    }",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:30001/field-permissions",
          "protocol": "http",
          "host": ["localhost"],
          "port": "30001",
          "path": ["field-permissions"]
        }
      },
      "response": []
    },
    {
      "name": "4. æµ‹è¯•æ‰€æœ‰æƒé™åˆ—è¡¨ï¼ˆç›´è¿ï¼‰",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Permissions list', function () {",
              "    const jsonData = pm.response.json();",
              "    console.log('ğŸ“Š æƒé™æ€»æ•°:', jsonData.total);",
              "    console.log('ğŸ“ æƒé™åˆ—è¡¨é•¿åº¦:', jsonData.data.length);",
              "    pm.expect(jsonData).to.have.property('data');",
              "    pm.expect(jsonData.data).to.be.an('array');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:30001/permissions?page=1&limit=100",
          "protocol": "http",
          "host": ["localhost"],
          "port": "30001",
          "path": ["permissions"],
          "query": [
            {
              "key": "page",
              "value": "1"
            },
            {
              "key": "limit",
              "value": "100"
            }
          ]
        }
      },
      "response": []
    }
  ]
}
