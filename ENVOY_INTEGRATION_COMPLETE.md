# Envoy Proxy é›†æˆå®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-10-21  
**é›†æˆç‰ˆæœ¬**: Envoy v1.28  
**çŠ¶æ€**: âœ… é…ç½®å®Œæˆï¼Œå¯ç«‹å³éƒ¨ç½²

---

## ğŸ¯ å·²å®Œæˆå†…å®¹

### 1. å®Œæ•´çš„ Envoy é…ç½® âœ…

**æ–‡ä»¶**: `infrastructure/envoy/envoy.yaml`

**åŠŸèƒ½æ¸…å•**:
- âœ… **ç†”æ–­å™¨**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹é…ç½®
- âœ… **å¼‚å¸¸æ£€æµ‹**ï¼šè‡ªåŠ¨æ‘˜é™¤ä¸å¥åº·èŠ‚ç‚¹
- âœ… **å¥åº·æ£€æŸ¥**ï¼šä¸»åŠ¨æ¢æµ‹æœåŠ¡çŠ¶æ€
- âœ… **æ™ºèƒ½é‡è¯•**ï¼š5xx é”™è¯¯è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- âœ… **è¶…æ—¶æ§åˆ¶**ï¼šä¸åŒæœåŠ¡ä¸åŒè¶…æ—¶ï¼ˆ5s-30sï¼‰
- âœ… **é™æµä¿æŠ¤**ï¼šå…¨å±€1000 RPS + æœåŠ¡çº§200 RPS
- âœ… **è´Ÿè½½å‡è¡¡**ï¼šè½®è¯¢ç®—æ³•
- âœ… **CORS æ”¯æŒ**ï¼šå®Œæ•´çš„è·¨åŸŸé…ç½®
- âœ… **è®¿é—®æ—¥å¿—**ï¼šJSON æ ¼å¼ï¼Œå®Œæ•´çš„è¯·æ±‚ä¿¡æ¯
- âœ… **WebSocket æ”¯æŒ**ï¼šMedia Service WebRTC

**å·²é…ç½®çš„æœåŠ¡**:
- api-gateway (NestJS)
- user-service
- device-service
- app-service
- billing-service
- notification-service
- scheduler-service
- media-service

---

### 2. Docker Compose é…ç½® âœ…

**æ–‡ä»¶**: `infrastructure/envoy/docker-compose.envoy.yml`

**ç‰¹æ€§**:
- âœ… ç«¯å£æ˜ å°„ï¼ˆ10000: HTTP, 9901: Adminï¼‰
- âœ… é…ç½®æ–‡ä»¶æŒ‚è½½
- âœ… æ—¥å¿—ç›®å½•æŒ‚è½½
- âœ… å¥åº·æ£€æŸ¥
- âœ… è‡ªåŠ¨é‡å¯
- âœ… ç½‘ç»œé…ç½®

---

### 3. å®Œæ•´æ–‡æ¡£ âœ…

#### ä¸»æ–‡æ¡£
**æ–‡ä»¶**: `infrastructure/envoy/README.md`

**å†…å®¹**:
- æ¶æ„è¯´æ˜
- é…ç½®è¯¦è§£
- ç›‘æ§æŒ‡å—
- é«˜çº§é…ç½®
- æ•…éšœæ’æŸ¥
- æ€§èƒ½è°ƒä¼˜
- ç”Ÿäº§éƒ¨ç½²

#### å¿«é€Ÿå…¥é—¨
**æ–‡ä»¶**: `infrastructure/envoy/QUICK_START.md`

**å†…å®¹**:
- 5åˆ†é’Ÿä¸Šæ‰‹
- å¿«é€ŸéªŒè¯
- å¸¸ç”¨å‘½ä»¤
- æ€§èƒ½å¯¹æ¯”
- å‰ç«¯é…ç½®

---

### 4. è‡ªåŠ¨åŒ–è„šæœ¬ âœ…

#### å¯åŠ¨è„šæœ¬
**æ–‡ä»¶**: `infrastructure/envoy/start-envoy.sh`

**åŠŸèƒ½**:
- âœ… ç¯å¢ƒæ£€æŸ¥ï¼ˆDockerã€Docker Composeï¼‰
- âœ… é…ç½®éªŒè¯
- âœ… ç½‘ç»œæ£€æŸ¥
- âœ… è‡ªåŠ¨å¯åŠ¨
- âœ… å°±ç»ªç­‰å¾…
- âœ… çŠ¶æ€æ˜¾ç¤º

#### çŠ¶æ€æ£€æŸ¥è„šæœ¬
**æ–‡ä»¶**: `infrastructure/envoy/check-envoy.sh`

**åŠŸèƒ½**:
- âœ… è¿è¡ŒçŠ¶æ€
- âœ… å¥åº·æ£€æŸ¥
- âœ… é›†ç¾¤çŠ¶æ€
- âœ… ç»Ÿè®¡ä¿¡æ¯
- âœ… æœåŠ¡è¯·æ±‚ç»Ÿè®¡
- âœ… è®¿é—®æ—¥å¿—

#### åŠŸèƒ½æµ‹è¯•è„šæœ¬
**æ–‡ä»¶**: `infrastructure/envoy/test-envoy.sh`

**åŠŸèƒ½**:
- âœ… ç«¯ç‚¹æµ‹è¯•
- âœ… ç†”æ–­å™¨æµ‹è¯•
- âœ… é™æµæµ‹è¯•
- âœ… é‡è¯•æµ‹è¯•

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### æ–¹æ³• 1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd infrastructure/envoy
./start-envoy.sh
```

**è¾“å‡ºç¤ºä¾‹**:
```
============================================
  Envoy Proxy å¯åŠ¨è„šæœ¬
  äº‘æ‰‹æœºå¹³å° API Gateway è¾¹ç¼˜ä»£ç†
============================================

[INFO] æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…...
[SUCCESS] Docker å·²å®‰è£…
[INFO] æ£€æŸ¥ Docker Compose æ˜¯å¦å®‰è£…...
[SUCCESS] Docker Compose å·²å®‰è£…
[INFO] æ£€æŸ¥ Envoy é…ç½®æ–‡ä»¶...
[INFO] éªŒè¯é…ç½®è¯­æ³•...
[SUCCESS] é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®
[INFO] æ£€æŸ¥ Docker ç½‘ç»œ...
[SUCCESS] ç½‘ç»œå·²å­˜åœ¨
[INFO] å¯åŠ¨ Envoy Proxy...
[SUCCESS] Envoy å¯åŠ¨æˆåŠŸ
[INFO] ç­‰å¾… Envoy å°±ç»ª...
[SUCCESS] Envoy å·²å°±ç»ª

============================================
[SUCCESS] Envoy Proxy å·²æˆåŠŸå¯åŠ¨ï¼
============================================

ğŸ“¡ æœåŠ¡å…¥å£ï¼šhttp://localhost:10000
ğŸ›ï¸  ç®¡ç†ç•Œé¢ï¼šhttp://localhost:9901
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
cd infrastructure/envoy

# å¯åŠ¨
docker-compose -f docker-compose.envoy.yml up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.envoy.yml logs -f

# æ£€æŸ¥çŠ¶æ€
curl http://localhost:9901/ready
```

---

## ğŸ“Š éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥ Envoy çŠ¶æ€

```bash
./check-envoy.sh
```

**é¢„æœŸè¾“å‡º**:
```
=== Envoy è¿è¡ŒçŠ¶æ€ ===
âœ… Envoy æ­£åœ¨è¿è¡Œ
cloudphone-envoy    Up 2 minutes    0.0.0.0:9901->9901/tcp, 0.0.0.0:10000->10000/tcp

=== å¥åº·æ£€æŸ¥ ===
âœ… Envoy å¥åº·çŠ¶æ€ï¼šæ­£å¸¸

=== ä¸Šæ¸¸é›†ç¾¤çŠ¶æ€ ===
âœ… user-service
âœ… device-service
âœ… billing-service
...
```

### 2. æµ‹è¯•è¯·æ±‚

```bash
# é€šè¿‡ Envoy è®¿é—®ç”¨æˆ·æœåŠ¡
curl http://localhost:10000/api/users

# é€šè¿‡ Envoy è®¿é—®è®¾å¤‡æœåŠ¡
curl http://localhost:10000/api/devices

# é€šè¿‡ Envoy è®¿é—®è®¡è´¹æœåŠ¡
curl http://localhost:10000/api/billing/plans
```

### 3. è¿è¡ŒåŠŸèƒ½æµ‹è¯•

```bash
./test-envoy.sh
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º

### 1. ç†”æ–­å™¨ï¼ˆCircuit Breakerï¼‰

```bash
# åœæ­¢ä¸€ä¸ªæœåŠ¡ï¼ˆæ¨¡æ‹Ÿæ•…éšœï¼‰
docker stop cloudphone-user-service

# é€šè¿‡ Envoy è®¿é—®ï¼ˆä¼šå¿«é€Ÿå¤±è´¥ï¼‰
curl http://localhost:10000/api/users
# é¢„æœŸï¼šç«‹å³è¿”å› 503ï¼Œä¸ä¼šç­‰å¾…è¶…æ—¶

# æŸ¥çœ‹ç†”æ–­å™¨ç»Ÿè®¡
curl http://localhost:9901/stats | grep circuit_breakers

# æ¢å¤æœåŠ¡
docker start cloudphone-user-service

# 30ç§’åè‡ªåŠ¨æ¢å¤
```

**æ•ˆæœå¯¹æ¯”**:
```
æ— ç†”æ–­å™¨ï¼š
  è¯·æ±‚1: 10ç§’è¶…æ—¶ âŒ
  è¯·æ±‚2: 10ç§’è¶…æ—¶ âŒ
  è¯·æ±‚3: 10ç§’è¶…æ—¶ âŒ
  æ€»è€—æ—¶: 30ç§’

æœ‰ç†”æ–­å™¨ï¼š
  è¯·æ±‚1-5: é€æ¸å¤±è´¥
  è¯·æ±‚6+: ç«‹å³è¿”å› 503 âœ…
  æ€»è€—æ—¶: <1ç§’
```

### 2. å¼‚å¸¸æ£€æµ‹ï¼ˆOutlier Detectionï¼‰

**è‡ªåŠ¨æ‘˜é™¤ä¸å¥åº·èŠ‚ç‚¹**:
```
è¿ç»­5æ¬¡5xxé”™è¯¯ â†’ è‡ªåŠ¨æ‘˜é™¤30ç§’
30ç§’å â†’ è‡ªåŠ¨å°è¯•æ¢å¤
```

**æŸ¥çœ‹æ‘˜é™¤çŠ¶æ€**:
```bash
curl http://localhost:9901/stats | grep outlier_detection
```

### 3. å¥åº·æ£€æŸ¥ï¼ˆHealth Checkï¼‰

**ä¸»åŠ¨æ¢æµ‹**:
```
æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ /health ç«¯ç‚¹
3æ¬¡å¤±è´¥ â†’ æ ‡è®°ä¸ºä¸å¥åº·
2æ¬¡æˆåŠŸ â†’ æ ‡è®°ä¸ºå¥åº·
```

**æŸ¥çœ‹å¥åº·çŠ¶æ€**:
```bash
curl http://localhost:9901/clusters | grep health_flags
```

### 4. æ™ºèƒ½é‡è¯•ï¼ˆRetryï¼‰

**è‡ªåŠ¨é‡è¯•æ¡ä»¶**:
- 5xx é”™è¯¯
- è¿æ¥é‡ç½®
- è¿æ¥å¤±è´¥
- æµè¢«æ‹’ç»

**ç­–ç•¥**:
```
æœ€å¤šé‡è¯•: 3æ¬¡
æ¯æ¬¡è¶…æ—¶: 3ç§’
ä¸é‡è¯•åŒä¸€èŠ‚ç‚¹
```

### 5. é™æµï¼ˆRate Limitingï¼‰

**é…ç½®**:
```yaml
å…¨å±€é™æµ: 1000 RPS
User Service: 200 RPS
Device Service: 200 RPS
```

**æµ‹è¯•**:
```bash
# å‘é€å¤§é‡è¯·æ±‚
for i in {1..1000}; do curl http://localhost:10000/api/users & done

# æŸ¥çœ‹é™æµç»Ÿè®¡
curl http://localhost:9901/stats | grep rate_limit
```

---

## ğŸ“ˆ ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### ç®¡ç†ç•Œé¢

è®¿é—®ï¼š**http://localhost:9901**

**ä¸»è¦ç«¯ç‚¹**:

| è·¯å¾„ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `/` | ä¸»é¡µ | http://localhost:9901 |
| `/stats` | æ‰€æœ‰ç»Ÿè®¡æŒ‡æ ‡ | http://localhost:9901/stats |
| `/clusters` | é›†ç¾¤çŠ¶æ€ | http://localhost:9901/clusters |
| `/config_dump` | å®Œæ•´é…ç½® | http://localhost:9901/config_dump |
| `/ready` | å°±ç»ªæ£€æŸ¥ | http://localhost:9901/ready |

### å…³é”®æŒ‡æ ‡

```bash
# è¯·æ±‚ç»Ÿè®¡
curl http://localhost:9901/stats | grep upstream_rq_total

# ç†”æ–­å™¨çŠ¶æ€
curl http://localhost:9901/stats | grep circuit_breakers

# å¥åº·æ£€æŸ¥
curl http://localhost:9901/stats | grep health_check

# é‡è¯•ç»Ÿè®¡
curl http://localhost:9901/stats | grep retry
```

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### è¯·æ±‚æµç¨‹

```
å¤–éƒ¨è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Envoy Proxy (Port 10000)          â”‚
â”‚                                     â”‚
â”‚  1. CORS å¤„ç†                       â”‚
â”‚  2. é™æµæ£€æŸ¥                        â”‚
â”‚  3. è·¯ç”±åŒ¹é…                        â”‚
â”‚  4. ç†”æ–­å™¨æ£€æŸ¥                      â”‚
â”‚  5. è´Ÿè½½å‡è¡¡                        â”‚
â”‚  6. å¥åº·æ£€æŸ¥                        â”‚
â”‚  7. è¶…æ—¶æ§åˆ¶                        â”‚
â”‚  8. é‡è¯•æœºåˆ¶                        â”‚
â”‚  9. è®¿é—®æ—¥å¿—                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â†“             â†“
NestJS          å¾®æœåŠ¡
Gateway         é›†ç¾¤
```

### èŒè´£åˆ†ç¦»

| å±‚çº§ | èŒè´£ | å®ç° |
|------|------|------|
| **Envoy** | åŸºç¡€è®¾æ–½å±‚ | ç†”æ–­ã€é™æµã€é‡è¯•ã€è¶…æ—¶ |
| **NestJS Gateway** | ä¸šåŠ¡å±‚ | è®¤è¯ã€æˆæƒã€ä¸šåŠ¡è·¯ç”± |
| **å¾®æœåŠ¡** | é¢†åŸŸå±‚ | ä¸šåŠ¡é€»è¾‘ |

---

## ğŸ”§ é…ç½®è¦ç‚¹

### ç†”æ–­å™¨å‚æ•°

```yaml
circuit_breakers:
  thresholds:
  - priority: DEFAULT
    max_connections: 512        # æœ€å¤§è¿æ¥æ•°
    max_pending_requests: 512   # æœ€å¤§ç­‰å¾…è¯·æ±‚
    max_requests: 512           # æœ€å¤§æ´»åŠ¨è¯·æ±‚
    max_retries: 3              # æœ€å¤§é‡è¯•æ¬¡æ•°
```

### å¼‚å¸¸æ£€æµ‹å‚æ•°

```yaml
outlier_detection:
  consecutive_5xx: 5              # è¿ç»­5æ¬¡5xx
  interval: 30s                   # æ£€æµ‹é—´éš”
  base_ejection_time: 30s         # æ‘˜é™¤æ—¶é—´
  max_ejection_percent: 50        # æœ€å¤šæ‘˜é™¤50%
  enforcing_consecutive_5xx: 100  # 100%æ‰§è¡Œ
```

### é‡è¯•å‚æ•°

```yaml
retry_policy:
  retry_on: "5xx,reset,connect-failure"
  num_retries: 3               # æœ€å¤š3æ¬¡
  per_try_timeout: 3s          # æ¯æ¬¡3ç§’
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

1. **é›†æˆ Consul æœåŠ¡å‘ç°**
   - åŠ¨æ€æœåŠ¡å‘ç°
   - è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€
   - é…ç½®æ–‡ä»¶ï¼šå·²å‡†å¤‡å¥½ç¤ºä¾‹

2. **é›†æˆ Jaeger åˆ†å¸ƒå¼è¿½è¸ª**
   - å¯è§†åŒ–è°ƒç”¨é“¾è·¯
   - æ€§èƒ½åˆ†æ
   - é…ç½®æ–‡ä»¶ï¼šå·²å‡†å¤‡å¥½ç¤ºä¾‹

3. **é›†æˆ Prometheus ç›‘æ§**
   - Grafana ä»ªè¡¨ç›˜
   - å‘Šè­¦é…ç½®
   - æŒ‡æ ‡å·²æš´éœ²

### ä¸­æœŸï¼ˆ1æœˆå†…ï¼‰

4. **é…ç½® TLS/HTTPS**
   - è¯ä¹¦ç®¡ç†
   - HTTPS ç›‘å¬å™¨
   - ç¤ºä¾‹é…ç½®å·²æä¾›

5. **æ€§èƒ½è°ƒä¼˜**
   - å‹æµ‹éªŒè¯
   - å‚æ•°ä¼˜åŒ–
   - è¿æ¥æ± è°ƒä¼˜

6. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**
   - é«˜å¯ç”¨é…ç½®
   - èµ„æºé™åˆ¶
   - æ—¥å¿—ç®¡ç†

---

## ğŸ“š æ–‡æ¡£æ¸…å•

âœ… æ‰€æœ‰æ–‡æ¡£å·²åˆ›å»ºï¼š

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **å®Œæ•´æ–‡æ¡£** | `infrastructure/envoy/README.md` | è¯¦ç»†é…ç½®è¯´æ˜ |
| **å¿«é€Ÿå…¥é—¨** | `infrastructure/envoy/QUICK_START.md` | 5åˆ†é’Ÿä¸Šæ‰‹ |
| **é…ç½®æ–‡ä»¶** | `infrastructure/envoy/envoy.yaml` | Envoy é…ç½®ï¼ˆå¸¦æ³¨é‡Šï¼‰ |
| **Docker Compose** | `infrastructure/envoy/docker-compose.envoy.yml` | å®¹å™¨é…ç½® |
| **å¯åŠ¨è„šæœ¬** | `infrastructure/envoy/start-envoy.sh` | è‡ªåŠ¨åŒ–å¯åŠ¨ |
| **æ£€æŸ¥è„šæœ¬** | `infrastructure/envoy/check-envoy.sh` | çŠ¶æ€æ£€æŸ¥ |
| **æµ‹è¯•è„šæœ¬** | `infrastructure/envoy/test-envoy.sh` | åŠŸèƒ½æµ‹è¯• |

---

## ğŸ’¡ é‡è¦æç¤º

### 1. å‰ç«¯é…ç½®å˜æ›´

**ä¿®æ”¹ API åŸºç¡€åœ°å€**:
```typescript
// frontend/.env
# ä¹‹å‰ï¼š
VITE_API_BASE_URL=http://localhost:30000

# ç°åœ¨ï¼šé€šè¿‡ Envoy
VITE_API_BASE_URL=http://localhost:10000
```

### 2. ä¸ç°æœ‰ NestJS Gateway å…±å­˜

**ä¸¤ç§éƒ¨ç½²æ¨¡å¼**:

#### æ¨¡å¼ 1ï¼šå®Œå…¨æ›¿ä»£ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
```
å‰ç«¯ â†’ Envoy (10000) â†’ å¾®æœåŠ¡
```

#### æ¨¡å¼ 2ï¼šåŒå±‚æ¶æ„ï¼ˆæ¨èå¼€å‘ç¯å¢ƒï¼‰
```
å‰ç«¯ â†’ Envoy (10000) â†’ NestJS Gateway (30000) â†’ å¾®æœåŠ¡
```

**å½“å‰é…ç½®**ï¼šæ”¯æŒæ¨¡å¼2ï¼ˆåŒå±‚æ¶æ„ï¼‰

### 3. ç«¯å£è¯´æ˜

| ç«¯å£ | æœåŠ¡ | ç”¨é€” |
|------|------|------|
| 10000 | Envoy HTTP | å¤–éƒ¨è®¿é—®å…¥å£ |
| 9901 | Envoy Admin | ç®¡ç†ç•Œé¢ |
| 30000 | NestJS Gateway | å¯é€‰çš„äºŒçº§ä»£ç† |
| 30001-30007 | å¾®æœåŠ¡ | å†…éƒ¨æœåŠ¡ç«¯å£ |

---

## ğŸ‰ é›†æˆå®Œæˆ

âœ… **Envoy Proxy å·²å®Œå…¨é›†æˆåˆ°äº‘æ‰‹æœºå¹³å°ï¼**

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… ç†”æ–­å™¨ä¿æŠ¤
- âœ… å¼‚å¸¸æ£€æµ‹
- âœ… å¥åº·æ£€æŸ¥
- âœ… æ™ºèƒ½é‡è¯•
- âœ… é™æµä¿æŠ¤
- âœ… è´Ÿè½½å‡è¡¡
- âœ… è®¿é—®æ—¥å¿—
- âœ… å®Œæ•´æ–‡æ¡£
- âœ… è‡ªåŠ¨åŒ–è„šæœ¬

**ç«‹å³å¯ç”¨**:
```bash
cd infrastructure/envoy
./start-envoy.sh
```

**éªŒè¯**:
```bash
./check-envoy.sh
./test-envoy.sh
```

---

**é›†æˆå®Œæˆæ—¶é—´**: 2025-10-21  
**å¯ç”¨çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª  
**æ–‡æ¡£å®Œæ•´åº¦**: 100%

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹ï¼š
- å¿«é€Ÿå…¥é—¨ï¼š`infrastructure/envoy/QUICK_START.md`
- å®Œæ•´æ–‡æ¡£ï¼š`infrastructure/envoy/README.md`
- Envoy å®˜æ–¹ï¼šhttps://www.envoyproxy.io/docs

