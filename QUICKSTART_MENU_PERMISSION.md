# 菜单权限管理 - 快速启动指南

## 🚀 5分钟快速上手

### 前提条件检查

```bash
# 1. 检查后端服务是否运行
pm2 list

# 应该看到以下服务运行中:
# - user-service (Port 30001)
# - api-gateway (Port 30000)

# 2. 如果服务未运行，启动它们
pm2 start user-service
pm2 start api-gateway

# 3. 验证服务健康状态
curl http://localhost:30001/health
curl http://localhost:30000/health
```

### 启动前端

```bash
# 进入前端目录
cd /home/eric/next-cloudphone/frontend/admin

# 安装依赖（如果还没安装）
pnpm install

# 启动开发服务器
pnpm dev

# 等待编译完成，看到类似信息:
# ➜  Local:   http://localhost:5173/
```

### 访问菜单权限管理

**方法1: 直接访问**
```
打开浏览器: http://localhost:5173/permissions/menu
```

**方法2: 通过导航**
```
1. 访问: http://localhost:5173/login
2. 登录管理后台
3. 点击导航: 权限管理 → 菜单权限
```

---

## 📖 功能使用指南

### 1. 查看菜单树 🌳

页面加载后，左侧会显示完整的菜单树结构：

```
├─ 📊 Dashboard
├─ 📱 设备管理
│  ├─ 设备列表 [device:list]
│  ├─ 设备模板 [device:template]
│  └─ 设备快照 [device:snapshot]
├─ 👥 用户管理
│  ├─ 用户列表 [user:list]
│  └─ 角色管理 [user:role]
└─ ...
```

**操作:**
- 点击节点展开/折叠子菜单
- 使用搜索框快速定位
- 点击"展开全部"/"折叠全部"按钮

### 2. 查看菜单详情 ℹ️

点击任意菜单项，右侧详情面板会显示：

- 菜单名称
- 路由路径
- 权限代码（如果有）
- 图标和组件信息
- 子菜单数量
- 元数据配置

### 3. 测试用户权限 🧪

**步骤:**

1. 点击右侧"测试用户菜单访问"按钮
2. 在弹窗中输入用户ID
3. 点击"加载菜单"
4. 查看该用户可见的菜单树

**示例:**
```
输入用户ID: 550e8400-e29b-41d4-a716-446655440000
结果: 显示该用户根据其角色和权限可以访问的菜单
```

### 4. 管理缓存 🗄️

**查看统计信息:**
- 已缓存用户数
- 活跃用户数
- 缓存命中率
- 平均加载时间

**操作:**

**刷新用户缓存:**
```
1. 点击"刷新用户缓存"
2. 输入用户ID
3. 确认操作
```

**预热缓存:**
```
1. 点击"预热缓存"
2. 系统会为最近100个活跃用户预加载权限
3. 提升系统响应速度
```

**清空所有缓存:**
```
⚠️ 危险操作！建议在非高峰期进行
1. 点击"清空所有缓存"
2. 确认警告
3. 所有用户权限缓存将被清空
```

**导出缓存数据:**
```
1. 点击"导出缓存数据"
2. 自动下载JSON文件
3. 文件名: menu-cache-YYYYMMDD-HHmmss.json
```

---

## 🎯 常见场景

### 场景1: 查找特定菜单的权限要求

```
1. 在搜索框输入菜单名称，如: "设备列表"
2. 系统自动过滤并高亮匹配项
3. 点击菜单项查看详情
4. 查看"权限代码"字段，如: device:list
```

### 场景2: 验证新用户的菜单访问

```
1. 创建新用户并分配角色
2. 打开菜单权限管理页面
3. 点击"测试用户菜单访问"
4. 输入新用户ID
5. 验证显示的菜单是否符合预期
```

### 场景3: 优化系统性能

```
# 查看缓存命中率
1. 查看统计卡片中的"缓存命中率"
2. 如果低于80%，考虑预热缓存

# 预热缓存
1. 在非高峰期（如凌晨）
2. 点击"预热缓存"
3. 为活跃用户预加载权限数据
4. 提升白天高峰期的响应速度
```

### 场景4: 排查权限问题

```
# 用户反馈看不到某个菜单
1. 获取用户ID
2. 使用"测试用户菜单访问"功能
3. 查看该用户可见的菜单树
4. 对比预期的菜单
5. 如果缺失，检查用户的角色和权限配置
```

---

## 🐛 故障排除

### 问题1: 页面显示空白

**原因**: 后端服务未运行

**解决**:
```bash
pm2 list
pm2 start user-service
pm2 start api-gateway
```

### 问题2: 无法加载菜单

**原因**: 用户未登录或token过期

**解决**:
```
1. 检查浏览器控制台错误
2. 重新登录
3. 刷新页面
```

### 问题3: 缓存操作失败

**原因**: 权限不足

**解决**:
```
1. 确认当前用户有缓存管理权限
2. 检查权限代码: permission:cache:manage
3. 联系管理员分配权限
```

### 问题4: 搜索结果不准确

**原因**: 搜索关键词不匹配

**解决**:
```
1. 尝试不同的关键词
2. 搜索支持菜单名称和路径
3. 使用部分匹配，如: "设备" 或 "/devices"
```

---

## 📊 性能优化建议

### 缓存管理最佳实践

**日常操作:**
- 每天查看缓存统计信息
- 保持缓存命中率在80%以上
- 定期预热缓存（每周一次）

**高峰期前:**
```bash
# 在业务高峰期前1小时
1. 点击"预热缓存"
2. 为活跃用户预加载权限
```

**低峰期维护:**
```bash
# 在低峰期（如凌晨2-4点）
1. 点击"清空所有缓存"
2. 点击"预热缓存"
3. 重建干净的缓存
```

### 监控指标

**关注以下指标:**

| 指标 | 健康范围 | 建议操作 |
|------|---------|---------|
| 缓存命中率 | > 80% | 良好，继续保持 |
| 缓存命中率 | 60-80% | 考虑预热缓存 |
| 缓存命中率 | < 60% | 立即预热缓存 |
| 平均加载时间 | < 100ms | 优秀 |
| 平均加载时间 | 100-300ms | 良好 |
| 平均加载时间 | > 300ms | 需要优化 |

---

## 💡 使用技巧

### 技巧1: 快速定位

```
使用快捷键 Ctrl+F (或 Cmd+F) 在页面内搜索
然后使用搜索框进一步过滤菜单树
```

### 技巧2: 批量测试

```
准备一个用户ID列表
逐个测试每个用户的菜单访问
记录结果用于权限审计
```

### 技巧3: 定期导出

```
每周导出一次缓存数据
用于备份和分析
比较不同时期的缓存状态
```

### 技巧4: 配合其他权限页面

```
菜单权限页面 → 查看菜单结构
↓
角色管理页面 → 配置角色权限
↓
数据范围权限页面 → 配置数据访问范围
↓
字段级权限页面 → 配置字段访问控制
```

---

## 📞 获取帮助

### 文档

- **详细实施文档**: [MENU_PERMISSION_IMPLEMENTATION.md](./MENU_PERMISSION_IMPLEMENTATION.md)
- **项目状态更新**: [PROJECT_STATUS_UPDATE.md](./PROJECT_STATUS_UPDATE.md)
- **后端API文档**: 查看 `backend/user-service` 的 Swagger 文档

### 支持

如有问题，请：
1. 查看浏览器控制台错误信息
2. 检查后端服务日志: `pm2 logs user-service`
3. 联系技术支持团队

---

## ✅ 快速检查清单

使用前确认：

- [ ] 后端服务运行正常
- [ ] 前端开发服务器已启动
- [ ] 用户已登录
- [ ] 浏览器控制台无错误
- [ ] 可以正常访问其他权限管理页面

---

**最后更新**: 2025-10-30
**版本**: 1.0.0
**维护者**: 开发团队
