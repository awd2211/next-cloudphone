# Logstash 主管道配置
# 开发环境：处理 PM2 + pino-pretty 格式的文本日志
# 生产环境：处理 Pino JSON 格式日志

# ==========================================
# INPUT - 从 Filebeat 接收日志
# ==========================================
input {
  beats {
    port => 5044
    host => "0.0.0.0"
  }
}

# ==========================================
# FILTER - 日志解析和转换
# ==========================================
filter {
  # 保留原始消息
  mutate {
    rename => { "message" => "[event][original]" }
  }

  # Filebeat 已经添加了以下字段（通过 fields_under_root: true）：
  # - service
  # - log_type
  # - environment

  # 这些字段可以直接在 output 中使用
}

# ==========================================
# OUTPUT - 发送到 Elasticsearch
# ==========================================
output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]

    # 按日期和服务名创建索引
    # service 字段由 Filebeat 提供
    index => "cloudphone-logs-%{service}-%{+YYYY.MM.dd}"

    # 管理索引模板
    manage_template => true
    template_name => "cloudphone-logs"
    template_overwrite => true
    template => "/usr/share/logstash/pipeline/template.json"
  }

  # 调试输出 (开发时可启用)
  # stdout {
  #   codec => rubydebug
  # }
}
