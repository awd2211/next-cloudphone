# AlertManager é…ç½®
# å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥ç®¡ç†

global:
  # å‘Šè­¦è§£å†³è¶…æ—¶æ—¶é—´ï¼ˆå¦‚æœåœ¨æ­¤æ—¶é—´å†…æœªæ”¶åˆ°å‘Šè­¦æ›´æ–°ï¼Œåˆ™è®¤ä¸ºå·²è§£å†³ï¼‰
  resolve_timeout: 5m

  # SMTP é…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  # æ³¨æ„ï¼šè¿™äº›æ˜¯ç¤ºä¾‹é…ç½®ï¼Œéœ€è¦æ ¹æ®å®é™… SMTP æœåŠ¡å™¨ä¿®æ”¹
  smtp_from: 'cloudphone-alerts@example.com'
  smtp_smarthost: 'smtp.example.com:587'
  smtp_auth_username: 'cloudphone-alerts@example.com'
  smtp_auth_password: 'your-password'
  smtp_require_tls: true

# ==========================================
# è·¯ç”±é…ç½® - å®šä¹‰å‘Šè­¦å¦‚ä½•åˆ†ç»„å’Œå‘é€
# ==========================================
route:
  # é»˜è®¤æ¥æ”¶å™¨ï¼ˆæ‰€æœ‰ä¸åŒ¹é…å­è·¯ç”±çš„å‘Šè­¦éƒ½å‘é€åˆ°è¿™é‡Œï¼‰
  receiver: 'default'

  # åˆ†ç»„ç»´åº¦ï¼šæŒ‰å‘Šè­¦åç§°ã€é›†ç¾¤å’ŒæœåŠ¡åˆ†ç»„
  # ç›¸åŒåˆ†ç»„çš„å‘Šè­¦ä¼šåˆå¹¶åœ¨ä¸€ä¸ªé€šçŸ¥ä¸­
  group_by: ['alertname', 'cluster', 'service']

  # åˆ†ç»„ç­‰å¾…æ—¶é—´ï¼šæ”¶åˆ°ç¬¬ä¸€ä¸ªå‘Šè­¦åç­‰å¾…å¤šä¹…æ‰å‘é€ï¼ˆç­‰å¾…æ›´å¤šå‘Šè­¦åˆå¹¶ï¼‰
  group_wait: 10s

  # åˆ†ç»„é—´éš”ï¼šåŒä¸€åˆ†ç»„å†…å·²å‘é€é€šçŸ¥åï¼Œä¸‹æ¬¡å‘é€æ–°å‘Šè­¦çš„é—´éš”
  group_interval: 10s

  # é‡å¤é€šçŸ¥é—´éš”ï¼šåŒä¸€å‘Šè­¦é‡å¤å‘é€çš„é—´éš”ï¼ˆå¦‚æœå‘Šè­¦æŒç»­è§¦å‘ï¼‰
  repeat_interval: 12h

  # ==========================================
  # å­è·¯ç”± - æŒ‰ä¼˜å…ˆçº§å’Œç±»å‹è·¯ç”±å‘Šè­¦
  # ==========================================
  routes:

  # 1. å…³é”®å‘Šè­¦ (Critical) - ç«‹å³é€šçŸ¥å¤šä¸ªæ¸ é“
  - match:
      severity: critical
    receiver: 'critical'
    group_wait: 5s           # æ›´çŸ­çš„ç­‰å¾…æ—¶é—´
    repeat_interval: 4h      # æ›´é¢‘ç¹çš„é‡å¤é€šçŸ¥
    continue: true           # ç»§ç»­åŒ¹é…åç»­è·¯ç”±

  # 2. è­¦å‘Šå‘Šè­¦ (Warning) - æ ‡å‡†é€šçŸ¥
  - match:
      severity: warning
    receiver: 'warning'
    group_wait: 30s          # ç­‰å¾…æ›´å¤šå‘Šè­¦åˆå¹¶
    repeat_interval: 24h     # æ¯å¤©æœ€å¤šä¸€æ¬¡

  # 3. æ•°æ®åº“ç›¸å…³å‘Šè­¦ - ä¸“é—¨çš„æ¥æ”¶å™¨
  - match_re:
      alertname: '(PostgreSQLDown|PostgreSQL.*|RedisDown|Redis.*)'
    receiver: 'database-team'
    group_by: ['alertname', 'instance']
    continue: true

  # 4. ä¸šåŠ¡å‘Šè­¦ - å‘é€ç»™ä¸šåŠ¡å›¢é˜Ÿ
  - match_re:
      alertname: '(High.*Rate|Low.*Rate|.*Business.*)'
    receiver: 'business-team'
    group_by: ['alertname', 'service']
    continue: true

  # 5. å¼€å‘ç¯å¢ƒå‘Šè­¦ - é™ä½é€šçŸ¥é¢‘ç‡
  - match:
      environment: development
    receiver: 'dev-team'
    repeat_interval: 24h

# ==========================================
# æŠ‘åˆ¶è§„åˆ™ - é˜²æ­¢å‘Šè­¦é£æš´
# ==========================================
inhibit_rules:

# è§„åˆ™ 1: å¦‚æœæœåŠ¡ä¸‹çº¿ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
- source_match:
    alertname: 'ServiceDown'
  target_match_re:
    alertname: '.*'
  equal: ['service']

# è§„åˆ™ 2: Critical å‘Šè­¦ä¼šæŠ‘åˆ¶åŒä¸€å®ä¾‹çš„ Warning å‘Šè­¦
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['instance', 'service']

# è§„åˆ™ 3: æ•°æ®åº“ä¸‹çº¿æ—¶ï¼ŒæŠ‘åˆ¶æ•°æ®åº“ç›¸å…³çš„å…¶ä»–å‘Šè­¦
- source_match:
    alertname: 'PostgreSQLDown'
  target_match_re:
    alertname: 'PostgreSQL.*'
  equal: ['instance']

- source_match:
    alertname: 'RedisDown'
  target_match_re:
    alertname: 'Redis.*'
  equal: ['instance']

- source_match:
    alertname: 'RabbitMQDown'
  target_match_re:
    alertname: 'RabbitMQ.*'
  equal: ['instance']

# ==========================================
# æ¥æ”¶å™¨é…ç½® - å®šä¹‰å‘Šè­¦å‘é€ç›®æ ‡
# ==========================================
receivers:

# ------------------------------------------------------------
# 1. é»˜è®¤æ¥æ”¶å™¨ - Webhook (å¯ç”¨äºé›†æˆè‡ªå®šä¹‰ç³»ç»Ÿ)
# ------------------------------------------------------------
- name: 'default'
  webhook_configs:
  - url: 'http://localhost:5001/alerts'
    send_resolved: true
    http_config:
      follow_redirects: true

  # å¯é€‰ï¼šæ·»åŠ æ—¥å¿—æ¥æ”¶å™¨ç”¨äºè°ƒè¯•
  # æ³¨æ„ï¼šAlertManager æ²¡æœ‰å†…ç½® log receiverï¼Œè¿™é‡Œæ³¨é‡Šæ‰
  # å¯ä»¥ä½¿ç”¨ webhook é…åˆç®€å•çš„ HTTP æœåŠ¡å™¨æ¥è®°å½•æ—¥å¿—

# ------------------------------------------------------------
# 2. å…³é”®å‘Šè­¦æ¥æ”¶å™¨ - å¤šæ¸ é“é€šçŸ¥
# ------------------------------------------------------------
- name: 'critical'

  # é‚®ä»¶é€šçŸ¥
  email_configs:
  - to: 'ops-team@example.com,oncall@example.com'
    from: 'cloudphone-alerts@example.com'
    headers:
      Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
    html: |
      <h2>ğŸš¨ ä¸¥é‡å‘Šè­¦</h2>
      <p><strong>å‘Šè­¦åç§°:</strong> {{ .GroupLabels.alertname }}</p>
      <p><strong>æœåŠ¡:</strong> {{ .GroupLabels.service }}</p>
      <p><strong>é›†ç¾¤:</strong> {{ .GroupLabels.cluster }}</p>
      <p><strong>è§¦å‘æ—¶é—´:</strong> {{ .StartsAt }}</p>
      <hr>
      {{ range .Alerts }}
      <h3>{{ .Labels.alertname }}</h3>
      <p><strong>æ‘˜è¦:</strong> {{ .Annotations.summary }}</p>
      <p><strong>æè¿°:</strong> {{ .Annotations.description }}</p>
      <p><strong>å®ä¾‹:</strong> {{ .Labels.instance }}</p>
      <hr>
      {{ end }}
    send_resolved: true

  # Lark (é£ä¹¦) é€šçŸ¥
  webhook_configs:
  - url: 'http://alertmanager-lark-webhook:5001/lark-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

  # Telegram é€šçŸ¥
  - url: 'http://alertmanager-telegram-bot:5002/telegram-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

# ------------------------------------------------------------
# 3. è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
# ------------------------------------------------------------
- name: 'warning'

  email_configs:
  - to: 'dev-team@example.com'
    from: 'cloudphone-alerts@example.com'
    headers:
      Subject: 'âš ï¸ [WARNING] {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
    html: |
      <h2>âš ï¸ è­¦å‘Šå‘Šè­¦</h2>
      <p><strong>å‘Šè­¦åç§°:</strong> {{ .GroupLabels.alertname }}</p>
      <p><strong>æœåŠ¡:</strong> {{ .GroupLabels.service }}</p>
      <p><strong>è§¦å‘æ—¶é—´:</strong> {{ .StartsAt }}</p>
      <hr>
      {{ range .Alerts }}
      <p><strong>æ‘˜è¦:</strong> {{ .Annotations.summary }}</p>
      <p><strong>å®ä¾‹:</strong> {{ .Labels.instance }}</p>
      <hr>
      {{ end }}
    send_resolved: true

  # Lark (é£ä¹¦) é€šçŸ¥
  webhook_configs:
  - url: 'http://alertmanager-lark-webhook:5001/lark-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

  # Telegram é€šçŸ¥
  - url: 'http://alertmanager-telegram-bot:5002/telegram-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

# ------------------------------------------------------------
# 4. æ•°æ®åº“å›¢é˜Ÿæ¥æ”¶å™¨
# ------------------------------------------------------------
- name: 'database-team'

  email_configs:
  - to: 'dba-team@example.com'
    from: 'cloudphone-alerts@example.com'
    headers:
      Subject: 'ğŸ—„ï¸ [DATABASE] {{ .GroupLabels.alertname }}'
    html: |
      <h2>ğŸ—„ï¸ æ•°æ®åº“å‘Šè­¦</h2>
      <p><strong>å‘Šè­¦:</strong> {{ .GroupLabels.alertname }}</p>
      <p><strong>å®ä¾‹:</strong> {{ .GroupLabels.instance }}</p>
      <hr>
      {{ range .Alerts }}
      <p><strong>æ‘˜è¦:</strong> {{ .Annotations.summary }}</p>
      <p><strong>æè¿°:</strong> {{ .Annotations.description }}</p>
      {{ end }}
    send_resolved: true

  # Lark (é£ä¹¦) é€šçŸ¥
  webhook_configs:
  - url: 'http://alertmanager-lark-webhook:5001/lark-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

  # Telegram é€šçŸ¥
  - url: 'http://alertmanager-telegram-bot:5002/telegram-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

# ------------------------------------------------------------
# 5. ä¸šåŠ¡å›¢é˜Ÿæ¥æ”¶å™¨
# ------------------------------------------------------------
- name: 'business-team'

  email_configs:
  - to: 'business-ops@example.com,product@example.com'
    from: 'cloudphone-alerts@example.com'
    headers:
      Subject: 'ğŸ“Š [BUSINESS] {{ .GroupLabels.alertname }}'
    html: |
      <h2>ğŸ“Š ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦</h2>
      <p><strong>å‘Šè­¦:</strong> {{ .GroupLabels.alertname }}</p>
      <p><strong>æœåŠ¡:</strong> {{ .GroupLabels.service }}</p>
      <hr>
      {{ range .Alerts }}
      <p><strong>æ‘˜è¦:</strong> {{ .Annotations.summary }}</p>
      <p><strong>å½“å‰å€¼:</strong> {{ .Annotations.value }}</p>
      <p><strong>é˜ˆå€¼:</strong> {{ .Annotations.threshold }}</p>
      {{ end }}
    send_resolved: true

  # Lark (é£ä¹¦) é€šçŸ¥
  webhook_configs:
  - url: 'http://alertmanager-lark-webhook:5001/lark-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

  # Telegram é€šçŸ¥
  - url: 'http://alertmanager-telegram-bot:5002/telegram-webhook'
    send_resolved: true
    http_config:
      follow_redirects: true

# ------------------------------------------------------------
# 6. å¼€å‘å›¢é˜Ÿæ¥æ”¶å™¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
# ------------------------------------------------------------
- name: 'dev-team'

  # å¼€å‘ç¯å¢ƒåªå‘é€ webhookï¼Œé¿å…é‚®ä»¶è½°ç‚¸
  webhook_configs:
  - url: 'http://localhost:5001/dev-alerts'
    send_resolved: true

# ==========================================
# æ¨¡æ¿é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==========================================
# templates:
#   - '/etc/alertmanager/templates/*.tmpl'

# ==========================================
# é…ç½®è¯´æ˜
# ==========================================
#
# 1. è·¯ç”±ä¼˜å…ˆçº§
#    - å­è·¯ç”±æŒ‰é¡ºåºåŒ¹é…
#    - ä½¿ç”¨ continue: true å¯ä»¥è®©ä¸€ä¸ªå‘Šè­¦åŒ¹é…å¤šä¸ªè·¯ç”±
#    - æœªåŒ¹é…ä»»ä½•å­è·¯ç”±çš„å‘Šè­¦ä¼šå‘é€åˆ°é»˜è®¤æ¥æ”¶å™¨
#
# 2. åˆ†ç»„ç­–ç•¥
#    - group_by: å®šä¹‰åˆ†ç»„ç»´åº¦
#    - group_wait: æ”¶åˆ°ç¬¬ä¸€ä¸ªå‘Šè­¦åç­‰å¾…æ—¶é—´ï¼ˆç­‰å¾…æ›´å¤šå‘Šè­¦åˆå¹¶ï¼‰
#    - group_interval: åŒä¸€åˆ†ç»„çš„æ–°å‘Šè­¦å‘é€é—´éš”
#    - repeat_interval: åŒä¸€å‘Šè­¦çš„é‡å¤é€šçŸ¥é—´éš”
#
# 3. æŠ‘åˆ¶è§„åˆ™
#    - é˜²æ­¢å‘Šè­¦é£æš´
#    - source_match: è§¦å‘æŠ‘åˆ¶çš„å‘Šè­¦æ¡ä»¶
#    - target_match: è¢«æŠ‘åˆ¶çš„å‘Šè­¦æ¡ä»¶
#    - equal: åŒ¹é…ç»´åº¦ï¼ˆå¦‚ instance, serviceï¼‰
#
# 4. æ¥æ”¶å™¨ç±»å‹
#    - email: é‚®ä»¶é€šçŸ¥
#    - webhook: HTTP å›è°ƒ
#    - slack: Slack é€šçŸ¥
#    - pagerduty: PagerDuty é›†æˆ
#    - wechat: ä¼ä¸šå¾®ä¿¡é€šçŸ¥
#    - dingtalk: é’‰é’‰é€šçŸ¥ï¼ˆé€šè¿‡ webhookï¼‰
#
# 5. é’‰é’‰é€šçŸ¥é…ç½®ï¼ˆä¸‹ä¸€æ­¥å°†é…ç½®ï¼‰
#    è§é…ç½®ä»»åŠ¡ï¼šé…ç½®é’‰é’‰é€šçŸ¥æ¸ é“
