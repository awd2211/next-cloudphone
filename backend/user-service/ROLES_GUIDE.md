# 云手机平台角色体系完整指南

## 概述

云手机平台采用基于角色的访问控制（RBAC），共设计了 **16 种角色**，涵盖管理、运营、财务、业务、测试等多个场景。

## 角色体系架构

```
云手机平台角色体系
├── 管理类 (Management) - 3个角色
│   ├── admin - 超级管理员
│   ├── tenant_admin - 租户管理员
│   └── department_admin - 部门管理员
│
├── 运营类 (Operations) - 3个角色
│   ├── devops - 运维工程师
│   ├── customer_service - 客服专员
│   └── auditor - 审核专员
│
├── 财务类 (Finance) - 2个角色
│   ├── finance - 财务专员
│   └── accountant - 会计
│
├── 业务类 (Business) - 4个角色
│   ├── user - 普通用户
│   ├── vip_user - VIP用户
│   ├── enterprise_user - 企业用户
│   └── developer - 开发者
│
├── 数据分析类 (Analytics) - 1个角色
│   └── data_analyst - 数据分析师
│
├── 测试类 (Test) - 1个角色
│   └── test_user - 测试用户
│
└── 特殊类 (Special) - 2个角色
    ├── readonly_user - 只读用户
    └── guest - 访客
```

## 权限等级说明

| 等级 | 说明 | 数据范围 | 典型角色 |
|------|------|---------|---------|
| **super** | 超级权限 | 全局所有数据 | admin |
| **system** | 系统权限 | 全局所有数据 | devops, finance, auditor, data_analyst, accountant |
| **tenant** | 租户权限 | 本租户数据 | tenant_admin, customer_service |
| **department** | 部门权限 | 本部门及子部门数据 | department_admin |
| **user** | 用户权限 | 个人数据 | user, vip_user, enterprise_user, developer |
| **guest** | 访客权限 | 公开数据 | guest |

## 详细角色说明

### 1. 管理类角色 (Management)

#### 1.1 超级管理员 (admin)

**角色ID**: `00000000-0000-0000-0000-000000000001`

**权限特征**:
- ✅ 系统最高权限
- ✅ 可以访问和管理所有资源
- ✅ 可以配置系统设置
- ✅ 可以管理所有用户和角色
- ✅ 可以查看所有审计日志
- ✅ 可以执行备份和恢复

**适用场景**:
- 平台创始人、CTO
- 系统架构师
- 紧急故障处理

**权限列表**:
- 所有权限 (`*`)

**限制**:
- 建议不超过 3 人
- 需要双因素认证
- 所有操作记录审计日志

#### 1.2 租户管理员 (tenant_admin)

**角色ID**: `00000000-0000-0000-0000-000000000003`

**权限特征**:
- ✅ 管理本租户的所有用户
- ✅ 管理本租户的所有设备
- ✅ 管理本租户的应用库
- ✅ 查看本租户的账单和统计
- ✅ 配置本租户的配额限制
- ❌ 不能访问其他租户数据
- ❌ 不能修改系统配置

**适用场景**:
- 企业客户的管理员
- 部门IT负责人
- 租户级别的资源管理

**数据范围**: `tenant`（本租户）

**典型使用场景**:
```
场景：某科技公司购买了云手机服务
- 租户管理员：公司IT主管
- 企业用户：公司员工（测试工程师、运营人员等）
- 租户管理员可以：
  * 为员工创建账号
  * 分配设备配额
  * 管理企业应用库
  * 查看企业使用统计
```

#### 1.3 部门管理员 (department_admin)

**角色ID**: `00000000-0000-0000-0000-000000000004`

**权限特征**:
- ✅ 管理本部门及子部门的用户
- ✅ 管理本部门的设备
- ✅ 查看本部门的报表
- ❌ 不能访问其他部门数据
- ❌ 不能修改租户配置

**适用场景**:
- 部门经理
- 团队负责人
- 项目组长

**数据范围**: `department`（本部门及子部门）

### 2. 运营类角色 (Operations)

#### 2.1 运维工程师 (devops)

**角色ID**: `00000000-0000-0000-0000-000000000005`

**权限特征**:
- ✅ 查看所有设备监控数据
- ✅ 查看系统日志和性能指标
- ✅ 执行设备维护操作
- ✅ 配置资源调度策略
- ✅ 执行备份和恢复
- ❌ 不能查看用户敏感信息（密码、支付信息）
- ❌ 不能修改财务数据

**适用场景**:
- 系统运维
- 性能优化
- 故障诊断和处理

**主要职责**:
- 7x24小时系统监控
- 故障快速响应
- 性能调优
- 容量规划

#### 2.2 客服专员 (customer_service)

**角色ID**: `00000000-0000-0000-0000-000000000006`

**权限特征**:
- ✅ 查看用户基本信息（用户名、邮箱、电话）
- ✅ 查看设备信息（名称、状态、配置）
- ✅ 查看订单记录
- ✅ 创建和处理工单
- ❌ 不能修改用户密码
- ❌ 不能查看支付密码和银行卡信息
- ❌ 不能删除数据
- ❌ 不能修改账单

**适用场景**:
- 在线客服
- 电话客服
- 工单处理

**数据范围**: `tenant`（本租户）

**敏感字段隐藏**:
- password（密码）
- bankCard（银行卡号）
- idCard（身份证号）
- paymentSecret（支付密钥）

#### 2.3 审核专员 (auditor)

**角色ID**: `00000000-0000-0000-0000-000000000007`

**权限特征**:
- ✅ 审核待上架应用
- ✅ 审核用户上传内容
- ✅ 查看审核历史记录
- ✅ 生成审核统计报表
- ❌ 不能修改应用代码
- ❌ 不能直接上架应用（需审核通过）

**适用场景**:
- 应用商店审核
- 内容合规审核
- 用户资质审核

**审核流程**:
1. 开发者上传应用
2. 审核专员检查应用（安全性、合规性）
3. 审核通过/拒绝
4. 通过后自动上架

### 3. 财务类角色 (Finance)

#### 3.1 财务专员 (finance)

**角色ID**: `00000000-0000-0000-0000-000000000008`

**权限特征**:
- ✅ 管理所有账单
- ✅ 处理支付和退款
- ✅ 生成财务报表
- ✅ 对账管理
- ✅ 发票管理
- ✅ 修改账单状态
- ❌ 不能修改系统配置
- ❌ 不能删除财务记录（仅标记）

**适用场景**:
- 财务主管
- 收费管理
- 对账结算

**主要职责**:
- 每月账单核对
- 处理退款申请
- 生成月度/年度财务报表
- 发票开具管理

#### 3.2 会计 (accountant)

**角色ID**: `00000000-0000-0000-0000-000000000009`

**权限特征**:
- ✅ 查看所有账单
- ✅ 查看支付记录
- ✅ 查看财务报表
- ✅ 导出财务数据
- ❌ **不能修改**任何财务数据
- ❌ 不能执行退款
- ❌ 不能删除记录

**适用场景**:
- 会计人员
- 财务分析
- 财务审计

**数据访问**: 只读（Read-Only）

### 4. 业务类角色 (Business)

#### 4.1 普通用户 (user)

**角色ID**: `00000000-0000-0000-0000-000000000002`

**资源配额**:
- 最大设备数: 10
- 最大存储: 100GB (102400 MB)
- 最大CPU: 8核
- 最大内存: 16GB (16384 MB)

**权限特征**:
- ✅ 创建和管理自己的设备
- ✅ 安装和卸载应用
- ✅ 查看自己的账单
- ✅ 在线支付
- ✅ 提交工单
- ❌ 不能查看其他用户数据
- ❌ 不能修改系统配置

**适用场景**:
- 个人用户
- 小型工作室
- 自由职业者

**定价**: 按需付费

#### 4.2 VIP用户 (vip_user)

**角色ID**: `00000000-0000-0000-0000-000000000010`

**资源配额**:
- 最大设备数: **50** ⬆️
- 最大存储: **500GB** ⬆️
- 最大CPU: **32核** ⬆️
- 最大内存: **64GB** ⬆️

**VIP特权**:
- ✅ 更高的资源配额
- ✅ 优先技术支持（2小时响应）
- ✅ 专属客服通道
- ✅ 高级功能访问（GPU加速、更多地域）
- ✅ 性能优化（更高的CPU优先级）
- ✅ 数据保留期延长

**适用场景**:
- 重度用户
- 中型企业
- 长期订阅客户

**定价**: 包月/包年优惠

#### 4.3 企业用户 (enterprise_user)

**角色ID**: `00000000-0000-0000-0000-000000000011`

**资源配额**:
- 最大设备数: 20
- 最大存储: 200GB
- 最大CPU: 16核
- 最大内存: 32GB

**企业特性**:
- ✅ 共享企业应用库
- ✅ 团队协作功能
- ✅ 企业级报表
- ✅ 统一计费（租户管理员付费）
- ✅ SSO单点登录（可选）

**适用场景**:
- 企业员工
- 团队成员
- 项目组

**数据范围**: `tenant`（可以访问企业共享资源）

#### 4.4 开发者 (developer)

**角色ID**: `00000000-0000-0000-0000-000000000012`

**资源配额**:
- 最大设备数: 30
- 最大应用数: 100
- 最大存储: 1TB
- API请求限制: 10,000/小时

**开发者特权**:
- ✅ 上传和管理应用
- ✅ API访问权限
- ✅ 开发者文档访问
- ✅ 应用统计数据
- ✅ 应用分发管理
- ✅ Webhook配置

**适用场景**:
- 应用开发者
- ISV合作伙伴
- 游戏工作室

**收益模式**:
- 应用收费分成
- API调用计费

### 5. 数据分析类角色 (Analytics)

#### 5.1 数据分析师 (data_analyst)

**角色ID**: `00000000-0000-0000-0000-000000000016`

**权限特征**:
- ✅ 访问所有数据报表
- ✅ 用户行为分析
- ✅ 设备使用统计
- ✅ 财务数据分析（汇总数据）
- ✅ 运营数据分析
- ✅ 导出数据（脱敏后）
- ❌ 不能查看个人敏感信息
- ❌ 不能修改任何数据

**数据访问**:
- ✅ 汇总统计数据
- ✅ 趋势分析数据
- ❌ 个人明细数据（需脱敏）

**适用场景**:
- 商业智能分析
- 运营决策支持
- 市场分析

**数据脱敏**:
- 用户名 → `user_***`
- 手机号 → `138****5678`
- 邮箱 → `abc***@example.com`

### 6. 测试类角色 (Test)

#### 6.1 测试用户 (test_user)

**角色ID**: `00000000-0000-0000-0000-000000000013`

**资源配额**:
- 最大设备数: **3**
- 最大存储: **10GB**
- 最大CPU: **4核**
- 最大内存: **4GB**

**权限特征**:
- ✅ 仅测试环境可用
- ✅ 创建测试设备
- ✅ 测试应用安装
- ❌ 不能访问生产数据
- ❌ 设备自动清理（24小时后）
- ❌ 数据不持久化

**适用场景**:
- 功能测试
- 演示环境
- 培训账号

**限制**:
- 环境：仅测试环境
- 时效：24小时自动清理
- 数据：不持久化

### 7. 特殊类角色 (Special)

#### 7.1 只读用户 (readonly_user)

**角色ID**: `00000000-0000-0000-0000-000000000014`

**权限特征**:
- ✅ 查看设备信息
- ✅ 查看应用信息
- ✅ 查看账单
- ❌ **不能创建**任何资源
- ❌ **不能修改**任何数据
- ❌ **不能删除**任何资源
- ❌ **不能执行**任何操作（启动/停止设备等）

**适用场景**:
- 审计查看
- 监控大屏
- 报表展示
- 临时查询

**典型场景**:
```
场景：老板想看运营数据但不想误操作
- 创建 readonly_user 账号
- 老板登录查看数据
- 确保不会误删除或修改
```

#### 7.2 访客 (guest)

**角色ID**: `00000000-0000-0000-0000-000000000015`

**权限特征**:
- ✅ 浏览公开内容
- ✅ 查看产品介绍
- ✅ 查看文档
- ❌ 不能创建账号
- ❌ 不能创建设备
- ❌ 不能访问私有数据
- ❌ 会话有时效性（1小时）

**适用场景**:
- 产品试用
- 在线演示
- 市场推广

**数据范围**: `public`（仅公开数据）

## 角色对比表

### 资源配额对比

| 角色 | 最大设备 | 最大存储 | 最大CPU | 最大内存 | 说明 |
|------|---------|---------|--------|---------|------|
| VIP用户 | 50 | 500GB | 32核 | 64GB | 最高配额 |
| 开发者 | 30 | 1TB | - | - | 存储最大 |
| 企业用户 | 20 | 200GB | 16核 | 32GB | 企业标准 |
| 普通用户 | 10 | 100GB | 8核 | 16GB | 标准配额 |
| 测试用户 | 3 | 10GB | 4核 | 4GB | 最小配额 |

### 权限范围对比

| 角色分类 | 数据范围 | 可访问数据 | 典型角色 |
|---------|---------|-----------|---------|
| 超级权限 | all | 所有数据 | admin |
| 系统权限 | all | 所有数据（部分字段受限） | devops, finance, auditor |
| 租户权限 | tenant | 本租户数据 | tenant_admin, customer_service |
| 部门权限 | department | 本部门数据 | department_admin |
| 个人权限 | self | 个人数据 | user, vip_user, developer |
| 公开权限 | public | 公开数据 | guest |

## 角色分配建议

### 小型团队（< 10人）

```
建议配置：
- 超级管理员 (admin) × 1
- 普通用户 (user) × 9

说明：
- 创始人或技术负责人担任 admin
- 其他成员使用 user 角色
- 成本最低，权限清晰
```

### 中型企业（10-100人）

```
建议配置：
- 超级管理员 (admin) × 1-2
- 租户管理员 (tenant_admin) × 1-2
- 部门管理员 (department_admin) × 3-5
- 运维工程师 (devops) × 1-2
- 客服专员 (customer_service) × 2-3
- 企业用户 (enterprise_user) × 其他

说明：
- 分级管理，提高效率
- 运维和客服专岗专人
- 企业用户共享资源
```

### 大型企业（> 100人）

```
建议配置：
- 超级管理员 (admin) × 2-3
- 租户管理员 (tenant_admin) × 3-5
- 部门管理员 (department_admin) × 10+
- 运维工程师 (devops) × 5-10
- 客服专员 (customer_service) × 10+
- 财务专员 (finance) × 2-3
- 会计 (accountant) × 2-3
- 审核专员 (auditor) × 3-5
- 数据分析师 (data_analyst) × 2-3
- 企业用户 (enterprise_user) × 其他

说明：
- 完整的角色体系
- 专业分工明确
- 支持多部门协作
```

## API使用示例

### 创建用户并分配角色

```bash
# 1. 创建用户
POST /users
{
  "username": "zhangsan",
  "email": "zhangsan@example.com",
  "password": "SecurePassword123!"
}

# 2. 分配角色
POST /users/{userId}/roles
{
  "roleIds": ["00000000-0000-0000-0000-000000000002"]  # user 角色
}

# 3. VIP用户升级
PUT /users/{userId}/roles
{
  "roleIds": ["00000000-0000-0000-0000-000000000010"]  # vip_user 角色
}
```

### 查询角色权限

```bash
# 获取所有角色
GET /roles

# 获取角色详情
GET /roles/{roleId}

# 获取角色的权限列表
GET /roles/{roleId}/permissions

# 获取用户的角色
GET /users/{userId}/roles
```

## 最佳实践

### 1. 最小权限原则

- ✅ 默认分配最低权限角色
- ✅ 根据需要逐步提升权限
- ❌ 避免滥用 admin 角色

### 2. 角色分离

- ✅ 财务和技术分离
- ✅ 开发和生产分离
- ✅ 审计和操作分离

### 3. 定期审查

- 每季度审查角色分配
- 移除离职员工权限
- 更新角色权限配置

### 4. 日志审计

- 所有 admin 操作记录日志
- 财务操作全程审计
- 敏感操作需要审批

### 5. 多因素认证

```
必须启用 MFA 的角色：
- admin（超级管理员）
- finance（财务专员）
- tenant_admin（租户管理员）
```

## 故障排查

### 问题：用户看不到某些菜单

**解决步骤**：
1. 检查用户角色：`GET /users/{userId}/roles`
2. 检查角色权限：`GET /roles/{roleId}/permissions`
3. 检查菜单权限配置：`GET /menu-permissions`

### 问题：用户超出配额限制

**解决步骤**：
1. 检查用户角色配额：查看 `roles.metadata.quotas`
2. 检查用户当前使用量：`GET /quotas/user/{userId}`
3. 升级用户角色或调整配额

### 问题：权限不生效

**解决步骤**:
1. 清除缓存：用户登出重新登录
2. 检查角色是否激活：`roles.isSystem = true`
3. 检查数据范围配置：`data_scopes` 表
4. 检查字段权限配置：`field_permissions` 表

## 相关文档

- [数据范围和字段权限配置指南](./DATA_SCOPE_AND_FIELD_PERMISSIONS_GUIDE.md)
- [RBAC权限系统设计](./RBAC_DESIGN.md)
- [菜单权限配置](./MENU_PERMISSION_GUIDE.md)
