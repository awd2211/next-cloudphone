# ========================================
# User Service 环境变量配置示例
# 复制此文件为 .env 并填入实际值
# ========================================

# ===== 运行环境 =====
NODE_ENV=development
PORT=30001

# ===== 数据库配置 =====
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_DATABASE=cloudphone_user

# 数据库连接池配置
DB_POOL_MIN=2
DB_POOL_MAX=20
DB_CONNECTION_TIMEOUT=10000
DB_IDLE_TIMEOUT=30000
DB_STATEMENT_TIMEOUT=30000

# ===== Redis 配置 =====
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_CACHE_DB=1

# ===== JWT 配置 =====
# 重要: 生产环境必须使用强密码 (建议 64+ 字符随机字符串)
# 可使用: openssl rand -base64 64 生成
JWT_SECRET=your-secret-key-change-in-production-use-at-least-32-characters
JWT_EXPIRES_IN=7d  # Token有效期：7天（开发和生产环境推荐，配合自动刷新机制）
JWT_REFRESH_EXPIRES_IN=7d

# ===== CORS 配置 =====
# 多个域名用逗号分隔
CORS_ORIGINS=http://localhost:5173,http://localhost:5174

# ===== RabbitMQ 配置 =====
RABBITMQ_URL=amqp://admin:admin123@localhost:5672/cloudphone
RABBITMQ_EXCHANGE=cloudphone.events
RABBITMQ_QUEUE_PREFIX=user-service

# ===== Consul 配置 =====
CONSUL_HOST=localhost
CONSUL_PORT=8500
CONSUL_SERVICE_NAME=user-service
CONSUL_SERVICE_PORT=30001

# ===== 限流配置 =====
# 全局限流 (请求数/时间窗口)
THROTTLE_TTL=60
THROTTLE_LIMIT=100

# 公开端点限流 (如健康检查)
PUBLIC_THROTTLE_TTL=60
PUBLIC_THROTTLE_LIMIT=500

# 严格限流 (敏感操作)
STRICT_THROTTLE_TTL=60
STRICT_THROTTLE_LIMIT=10

# ===== 用户配置 =====
# 密码策略
PASSWORD_MIN_LENGTH=8
PASSWORD_REQUIRE_UPPERCASE=true
PASSWORD_REQUIRE_LOWERCASE=true
PASSWORD_REQUIRE_NUMBER=true
PASSWORD_REQUIRE_SPECIAL=false

# 用户锁定策略
MAX_LOGIN_ATTEMPTS=5
LOGIN_LOCK_DURATION=900  # 15分钟 (秒)

# 会话配置
SESSION_TIMEOUT=1800  # 30分钟 (秒)
SESSION_ABSOLUTE_TIMEOUT=86400  # 24小时 (秒)

# ===== 多租户配置 =====
MULTI_TENANCY_ENABLED=true
DEFAULT_TENANT_ID=default

# ===== 配额配置 =====
# 默认配额限制
DEFAULT_MAX_DEVICES=10
DEFAULT_MAX_STORAGE_GB=100
DEFAULT_MAX_TRAFFIC_GB=1000
DEFAULT_MAX_CPU_CORES=20
DEFAULT_MAX_MEMORY_GB=40

# ===== 邮件配置 =====
SMTP_ENABLED=true
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@cloudphone.com

# ===== 验证码配置 =====
CAPTCHA_ENABLED=true
CAPTCHA_LENGTH=4
CAPTCHA_EXPIRY=300  # 5分钟 (秒)

# ===== API Keys 配置 =====
API_KEY_PREFIX=cp_
API_KEY_LENGTH=32
API_KEY_EXPIRY_DAYS=365

# ===== 审计日志配置 =====
AUDIT_LOG_ENABLED=true
AUDIT_LOG_RETENTION_DAYS=90

# ===== 事件溯源配置 =====
# Event Sourcing / CQRS
EVENT_SOURCING_ENABLED=true
SNAPSHOT_INTERVAL=10  # 每N个事件创建一次快照
SNAPSHOT_RETENTION=100  # 保留最近N个快照

# ===== 缓存配置 =====
CACHE_ENABLED=true
CACHE_TTL=300  # 5分钟 (秒)
CACHE_WARMUP_ON_START=true
CACHE_WARMUP_USER_LIMIT=100  # 预热活跃用户数量

# ===== 熔断器配置 =====
# Circuit Breaker 超时配置
CIRCUIT_BREAKER_TIMEOUT=30000  # 30秒 (毫秒)
CIRCUIT_BREAKER_ERROR_THRESHOLD=50  # 错误率阈值 (%)
CIRCUIT_BREAKER_VOLUME_THRESHOLD=10  # 最小请求数

# ===== 健康检查配置 =====
HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_DATABASE=true
HEALTH_CHECK_REDIS=true
HEALTH_CHECK_RABBITMQ=true

# 数据库连接池警告阈值
DB_POOL_WARNING_THRESHOLD=70  # 使用率 %
DB_POOL_CRITICAL_THRESHOLD=90  # 使用率 %

# ===== 监控配置 =====
METRICS_ENABLED=true
METRICS_PORT=30001
METRICS_PATH=/metrics

# ===== 分布式追踪配置 =====
TRACING_ENABLED=true
JAEGER_AGENT_HOST=localhost
JAEGER_AGENT_PORT=6831
JAEGER_SAMPLER_TYPE=const
JAEGER_SAMPLER_PARAM=1

# ===== 日志配置 =====
LOG_LEVEL=info  # debug | info | warn | error
LOG_FORMAT=json  # json | pretty
LOG_FILE_ENABLED=false
LOG_FILE_PATH=/var/log/cloudphone/user-service.log

# ===== 外部服务 URL =====
DEVICE_SERVICE_URL=http://localhost:30002
BILLING_SERVICE_URL=http://localhost:30005
NOTIFICATION_SERVICE_URL=http://localhost:30006
APP_SERVICE_URL=http://localhost:30003
API_GATEWAY_URL=http://localhost:30000

# ===== IP 过滤配置 =====
IP_FILTER_ENABLED=false
IP_WHITELIST=127.0.0.1,::1
IP_BLACKLIST=

# ===== 安全配置 =====
# CSRF 保护 (未来实现)
CSRF_ENABLED=false
CSRF_COOKIE_NAME=XSRF-TOKEN

# Cookie 配置
COOKIE_SECRET=your-cookie-secret-change-in-production
COOKIE_SECURE=false  # 生产环境设为 true
COOKIE_HTTP_ONLY=true
COOKIE_SAME_SITE=lax  # lax | strict | none

# ===== 2FA 配置 =====
TWO_FACTOR_ENABLED=false
TWO_FACTOR_ISSUER=CloudPhone Platform

# ===== 社交登录配置 =====
# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Facebook OAuth
FACEBOOK_APP_ID=your-facebook-app-id
FACEBOOK_APP_SECRET=your-facebook-app-secret

# Twitter (X) OAuth 2.0
TWITTER_CLIENT_ID=your-twitter-client-id
TWITTER_CLIENT_SECRET=your-twitter-client-secret

# 社交登录回调URL
SOCIAL_AUTH_CALLBACK_URL=http://localhost:5174/auth/callback

# ===== 工单系统配置 =====
TICKET_AUTO_ASSIGN=true
TICKET_CLOSE_AFTER_DAYS=30

# ===== Bull 队列配置 =====
BULL_REDIS_HOST=localhost
BULL_REDIS_PORT=6379
BULL_REDIS_DB=2

# ===== 性能优化 =====
# 慢查询日志
SLOW_QUERY_LOG_ENABLED=true
SLOW_QUERY_THRESHOLD_MS=1000

# 请求日志
REQUEST_LOG_ENABLED=true
REQUEST_LOG_BODY=false  # 生产环境建议关闭

# ===== 开发配置 =====
# 仅开发环境
DEV_AUTO_SEED=false  # 自动填充测试数据
DEV_RESET_DB=false  # 启动时重置数据库
