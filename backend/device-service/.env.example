# ========================================
# Device Service 环境变量配置示例
# 复制此文件为 .env 并填入实际值
# ========================================

# ===== 运行环境 =====
NODE_ENV=development
PORT=3002

# ===== 数据库配置 =====
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_DATABASE=cloudphone_device

# ===== Redis 配置 =====
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# ===== JWT 配置 =====
JWT_SECRET=your-secret-key-change-in-production
JWT_EXPIRES_IN=24h

# ========================================
# Docker 配置
# ========================================
DOCKER_HOST=/var/run/docker.sock
DOCKER_NETWORK=cloudphone_network
DOCKER_STORAGE_DRIVER=overlay2
DOCKER_DATA_ROOT=/var/lib/docker

# ========================================
# Redroid 配置
# ========================================
# Redroid 镜像标签（留空则根据 androidVersion 自动选择）
# 可选值: redroid/redroid:11.0.0-latest, redroid/redroid:12.0.0-latest, redroid/redroid:13.0.0-latest
REDROID_IMAGE=

# 默认 Android 版本 (11, 12, 13)
DEFAULT_ANDROID_VERSION=11

# GPU 加速 (需要宿主机支持 /dev/dri)
# 设置为 true 启用 GPU 加速，可提升图形性能
REDROID_ENABLE_GPU=false
REDROID_GPU_MODE=guest
REDROID_GPU_DRIVER=virgl

# 音频支持
REDROID_ENABLE_AUDIO=false

# ========================================
# 端口范围配置
# ========================================
# ADB 端口范围 (每个设备占用1个端口)
ADB_PORT_START=5555
ADB_PORT_END=6554

# WebRTC 端口范围
WEBRTC_PORT_START=8080
WEBRTC_PORT_END=9079

# SCRCPY 端口范围 (可选)
SCRCPY_PORT_START=27183
SCRCPY_PORT_END=28182

# ========================================
# 设备资源默认配置
# ========================================
DEFAULT_CPU_CORES=2
DEFAULT_MEMORY_MB=4096
DEFAULT_STORAGE_MB=10240
DEFAULT_RESOLUTION=1080x1920
DEFAULT_DPI=320

# ========================================
# ADB 配置
# ========================================
ADB_HOST=localhost
ADB_PORT=5037
ADB_CONNECTION_TIMEOUT=5000
ADB_COMMAND_TIMEOUT=30000

# 截图保存目录
SCREENSHOT_DIR=/tmp/screenshots

# ========================================
# 健康检查配置
# ========================================
# 健康检查间隔（秒）
HEALTH_CHECK_INTERVAL=30

# 设备心跳超时（秒）
DEVICE_HEARTBEAT_TIMEOUT=60

# 容器启动超时（秒）
CONTAINER_START_TIMEOUT=120

# Android 启动超时（秒）
ANDROID_BOOT_TIMEOUT=60

# 自动恢复功能
DEVICE_AUTO_RECOVERY=true

# 自动恢复重试次数
AUTO_RECOVERY_MAX_RETRIES=3

# ========================================
# 微服务地址
# ========================================
SCHEDULER_SERVICE_URL=http://localhost:30004
MEDIA_SERVICE_URL=http://localhost:30006

# ========================================
# 日志配置
# ========================================
LOG_LEVEL=info
LOG_FORMAT=json
ENABLE_FILE_LOGGING=true

# ========================================
# 生命周期自动化配置
# ========================================

# 自动清理配置
LIFECYCLE_CLEANUP_ENABLED=true
LIFECYCLE_IDLE_THRESHOLD_HOURS=24          # 闲置设备阈值（小时）
LIFECYCLE_ERROR_RETENTION_HOURS=1          # 错误设备保留时间（小时）
LIFECYCLE_STOPPED_RETENTION_DAYS=7         # 停止设备保留时间（天）
LIFECYCLE_RECOVERY_MAX_ATTEMPTS=3          # 最大恢复尝试次数

# 自动扩缩容配置
AUTOSCALING_ENABLED=true
AUTOSCALING_MIN_DEVICES=0                  # 最小设备数
AUTOSCALING_MAX_DEVICES=100                # 最大设备数
AUTOSCALING_TARGET_CPU=70                  # 目标CPU使用率（%）
AUTOSCALING_SCALE_UP_THRESHOLD=80          # 扩容阈值（%）
AUTOSCALING_SCALE_DOWN_THRESHOLD=30        # 缩容阈值（%）
AUTOSCALING_COOLDOWN_MINUTES=10            # 冷却期（分钟）

# 自动备份配置
BACKUP_SCHEDULE_ENABLED=true
BACKUP_INTERVAL_HOURS=24                   # 备份间隔（小时）
BACKUP_RETENTION_DAYS=30                   # 备份保留天数
MAX_BACKUPS_PER_DEVICE=10                  # 每个设备最大备份数
SNAPSHOT_DIR=/data/snapshots               # 快照存储目录

# ========================================
# 故障转移配置
# ========================================
FAILOVER_ENABLED=true
FAILOVER_HEARTBEAT_TIMEOUT_MINUTES=10      # 心跳超时阈值（分钟）
FAILOVER_MAX_CONSECUTIVE_FAILURES=3        # 最大连续故障次数
FAILOVER_AUTO_RECREATE_ENABLED=true        # 启用自动重建
FAILOVER_SNAPSHOT_RECOVERY_ENABLED=true    # 启用快照恢复
FAILOVER_MAX_RECOVERY_ATTEMPTS=3           # 最大恢复尝试次数
FAILOVER_COOLDOWN_MINUTES=15               # 恢复冷却期（分钟）

# ========================================
# 状态恢复配置
# ========================================
STATE_RECOVERY_ENABLED=true
STATE_RECOVERY_AUTO_HEAL_ENABLED=true      # 启用自动修复
STATE_RECOVERY_RECORD_OPERATIONS=true      # 记录操作历史
STATE_RECOVERY_MAX_OPERATION_HISTORY=1000  # 最大操作历史记录数
STATE_RECOVERY_CHECK_INTERVAL_MINUTES=15   # 检查间隔（分钟）

# ========================================
# 监控和指标配置
# ========================================
METRICS_ENABLED=true
METRICS_PORT=30002
METRICS_PATH=/metrics

# ========================================
# RabbitMQ 配置
# ========================================
RABBITMQ_URL=amqp://admin:admin123@localhost:5672
RABBITMQ_EXCHANGE=cloudphone.events
RABBITMQ_QUEUE_PREFIX=device-service

# ========================================
# Consul 配置
# ========================================
CONSUL_HOST=localhost
CONSUL_PORT=8500
CONSUL_SERVICE_NAME=device-service
CONSUL_SERVICE_PORT=30002

# ========================================
# 外部服务 URL
# ========================================
USER_SERVICE_URL=http://localhost:30001
BILLING_SERVICE_URL=http://localhost:30005
NOTIFICATION_SERVICE_URL=http://localhost:30006

# ========================================
# 配额降级策略配置
# ========================================
# 当配额服务（user-service）不可用时是否允许创建设备
# true: 允许（降级模式，使用缓存或降级配额）
# false: 拒绝（严格模式，保护系统）
# 建议生产环境设置为 true，提升可用性
QUOTA_ALLOW_ON_ERROR=true
