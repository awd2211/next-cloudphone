# ========================================
# Notification Service 环境变量配置示例
# 复制此文件为 .env 并填入实际值
# ========================================

# ===== 运行环境 =====
NODE_ENV=development
PORT=30006

# ===== 数据库配置 =====
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_DATABASE=cloudphone_notification

# ===== 数据库连接池配置（极致优化）=====
# 最小连接数（默认：CPU 核心数 / 2，至少 2，自动计算）
DB_POOL_MIN=2

# 最大连接数（默认：CPU 核心数 × 2 + 1，自动计算）
DB_POOL_MAX=9

# 连接获取超时（毫秒，默认 10秒）
DB_CONNECTION_TIMEOUT=10000

# 空闲连接超时（毫秒，默认 30秒）
DB_IDLE_TIMEOUT=30000

# 软空闲超时（毫秒，默认 60秒）
DB_SOFT_IDLE_TIMEOUT=60000

# 语句超时（毫秒，生产 30秒，开发 60秒）
DB_STATEMENT_TIMEOUT=30000

# 查询超时（毫秒，生产 30秒，开发 60秒）
DB_QUERY_TIMEOUT=30000

# 连接最大生命周期（秒，生产 30分钟，开发 无限制）
DB_MAX_LIFETIME=1800

# Prepared Statement 缓存查询数量（默认 256）
# ⭐ notification-service 写入密集型特别受益
DB_PREPARED_STATEMENT_CACHE_QUERIES=256

# Prepared Statement 缓存大小（MB，默认 25）
DB_PREPARED_STATEMENT_CACHE_SIZE=25

# 慢查询阈值（毫秒，notification-service 标准优化：1000ms）
# ⭐ 标准阈值，适合写入密集型服务
DB_SLOW_QUERY_THRESHOLD=1000

# 连接池资源检查间隔（毫秒，默认 10秒）
DB_EVICTION_RUN_INTERVAL=10000

# 应用名称（用于数据库连接标识）
DB_APPLICATION_NAME=notification-service

# SSL 配置（生产环境建议启用）
DB_SSL_REJECT_UNAUTHORIZED=true

# ===== Redis 配置 =====
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_CACHE_DB=1

# ===== JWT 配置 =====
# 重要: 必须与其他服务保持一致
JWT_SECRET=your-secret-key-change-in-production-use-at-least-32-characters
JWT_EXPIRES_IN=24h

# ===== CORS 配置 =====
CORS_ORIGINS=http://localhost:5173,http://localhost:5174

# ===== RabbitMQ 配置 =====
RABBITMQ_URL=amqp://admin:admin123@localhost:5672/cloudphone
RABBITMQ_EXCHANGE=cloudphone.events
RABBITMQ_QUEUE_PREFIX=notification-service

# RabbitMQ 消费者配置
RABBITMQ_PREFETCH_COUNT=10
RABBITMQ_RETRY_ATTEMPTS=3
RABBITMQ_RETRY_DELAY=1000  # 毫秒

# Dead Letter Exchange 配置
RABBITMQ_DLX_EXCHANGE=cloudphone.notifications.dlx
RABBITMQ_DLX_QUEUE=notification-service.dlx

# ===== Consul 配置 =====
CONSUL_HOST=localhost
CONSUL_PORT=8500
CONSUL_SERVICE_NAME=notification-service
CONSUL_SERVICE_PORT=30006

# ===== WebSocket 配置 =====
WS_ENABLED=true
WS_PORT=30006
WS_PATH=/ws
WS_CORS_ENABLED=true

# WebSocket 连接配置
WS_HEARTBEAT_INTERVAL=30000  # 30秒 (毫秒)
WS_HEARTBEAT_TIMEOUT=90000  # 90秒 (毫秒)
WS_MAX_CONNECTIONS=10000

# ===== 邮件配置 (SMTP) =====
EMAIL_ENABLED=true
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false  # true for 465, false for other ports
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# 发件人信息
EMAIL_FROM=noreply@cloudphone.com
EMAIL_FROM_NAME=CloudPhone Platform

# 邮件模板配置
EMAIL_TEMPLATE_DIR=./src/email/templates
EMAIL_DEFAULT_LOCALE=zh-CN

# 邮件发送限制
EMAIL_RATE_LIMIT=100  # 每小时最大发送数
EMAIL_RETRY_ATTEMPTS=3
EMAIL_RETRY_DELAY=5000  # 毫秒

# ===== SMS 配置 =====
SMS_ENABLED=false

# 阿里云短信
ALIYUN_SMS_ACCESS_KEY_ID=
ALIYUN_SMS_ACCESS_KEY_SECRET=
ALIYUN_SMS_SIGN_NAME=云手机平台
ALIYUN_SMS_REGION=cn-hangzhou

# 腾讯云短信
TENCENT_SMS_APP_ID=
TENCENT_SMS_APP_KEY=
TENCENT_SMS_SIGN_NAME=云手机平台

# Twilio (国际短信)
TWILIO_ACCOUNT_SID=
TWILIO_AUTH_TOKEN=
TWILIO_PHONE_NUMBER=

# ===== 推送通知配置 =====
# Firebase Cloud Messaging (FCM)
FCM_ENABLED=false
FCM_SERVER_KEY=
FCM_PROJECT_ID=

# Apple Push Notification Service (APNs)
APNS_ENABLED=false
APNS_KEY_ID=
APNS_TEAM_ID=
APNS_TOPIC=com.cloudphone.app
APNS_PRODUCTION=false

# ===== 通知模板配置 =====
# 模板存储
TEMPLATE_STORAGE=database  # database | file

# 模板缓存
TEMPLATE_CACHE_ENABLED=true
TEMPLATE_CACHE_TTL=3600  # 1小时 (秒)

# 模板变量验证
TEMPLATE_VALIDATE_VARIABLES=true

# ===== 通知配置 =====
# 通知去重
NOTIFICATION_DEDUP_ENABLED=true
NOTIFICATION_DEDUP_WINDOW=300  # 5分钟 (秒)

# 通知优先级队列
NOTIFICATION_PRIORITY_HIGH_DELAY=0
NOTIFICATION_PRIORITY_NORMAL_DELAY=5000  # 5秒
NOTIFICATION_PRIORITY_LOW_DELAY=30000  # 30秒

# 通知保留期
NOTIFICATION_RETENTION_DAYS=90

# 批量发送配置
NOTIFICATION_BATCH_SIZE=100
NOTIFICATION_BATCH_DELAY=1000  # 毫秒

# ===== 事件消费者配置 =====
# 设备事件
CONSUME_DEVICE_EVENTS=true

# 用户事件
CONSUME_USER_EVENTS=true

# 账单事件
CONSUME_BILLING_EVENTS=true

# 应用事件
CONSUME_APP_EVENTS=true

# 系统事件
CONSUME_SYSTEM_EVENTS=true

# 媒体事件
CONSUME_MEDIA_EVENTS=true

# 调度事件
CONSUME_SCHEDULER_EVENTS=true

# ===== 通知渠道优先级 =====
# 通道优先级顺序 (逗号分隔)
NOTIFICATION_CHANNEL_PRIORITY=websocket,email,sms,push

# 失败降级策略
NOTIFICATION_FALLBACK_ENABLED=true

# ===== 定时任务配置 =====
# 清理过期通知
CLEANUP_EXPIRED_ENABLED=true
CLEANUP_CRON=0 2 * * *  # 每天凌晨2点

# 重试失败的通知
RETRY_FAILED_ENABLED=true
RETRY_CRON=*/10 * * * *  # 每10分钟

# 统计报告
STATS_REPORT_ENABLED=true
STATS_REPORT_CRON=0 8 * * 1  # 每周一早上8点

# ===== 健康检查配置 =====
HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_DATABASE=true
HEALTH_CHECK_REDIS=true
HEALTH_CHECK_RABBITMQ=true
HEALTH_CHECK_SMTP=true

# ===== 监控配置 =====
METRICS_ENABLED=true
METRICS_PORT=30006
METRICS_PATH=/metrics

# 自定义指标
METRICS_TRACK_SEND_RATE=true
METRICS_TRACK_DELIVERY_RATE=true
METRICS_TRACK_CHANNEL_USAGE=true

# ===== 日志配置 =====
LOG_LEVEL=info  # debug | info | warn | error
LOG_FORMAT=json  # json | pretty
LOG_FILE_ENABLED=false
LOG_FILE_PATH=/var/log/cloudphone/notification-service.log

# 敏感信息脱敏
LOG_MASK_EMAIL=true
LOG_MASK_PHONE=true

# ===== 外部服务 URL =====
USER_SERVICE_URL=http://localhost:30001
DEVICE_SERVICE_URL=http://localhost:30002
BILLING_SERVICE_URL=http://localhost:30005
API_GATEWAY_URL=http://localhost:30000

# ===== 限流配置 =====
RATE_LIMIT_TTL=60
RATE_LIMIT_MAX=100

# 每用户通知限流
USER_NOTIFICATION_LIMIT=50  # 每小时
USER_EMAIL_LIMIT=20  # 每小时
USER_SMS_LIMIT=10  # 每小时

# ===== 安全配置 =====
# Cookie 配置 (WebSocket 认证)
COOKIE_SECRET=your-cookie-secret-change-in-production
COOKIE_SECURE=false  # 生产环境设为 true
COOKIE_HTTP_ONLY=true

# WebSocket 认证
WS_AUTH_REQUIRED=true
WS_AUTH_TIMEOUT=5000  # 5秒

# ===== 性能优化 =====
# 连接池
EMAIL_POOL_SIZE=5
SMS_POOL_SIZE=10

# 消息队列
NOTIFICATION_QUEUE_CONCURRENCY=10

# 数据库查询优化
DB_QUERY_CACHE_ENABLED=true
DB_QUERY_CACHE_TTL=60  # 秒

# ===== Webhook 配置 (可选) =====
WEBHOOK_ENABLED=false
WEBHOOK_URL=
WEBHOOK_SECRET=
WEBHOOK_RETRY_ATTEMPTS=3

# ===== 开发配置 =====
# 仅开发环境
DEV_AUTO_SEED_TEMPLATES=false  # 自动填充模板
DEV_MOCK_EMAIL=false  # 模拟邮件发送
DEV_MOCK_SMS=false  # 模拟短信发送
DEV_LOG_EMAIL_CONTENT=true  # 记录邮件内容
