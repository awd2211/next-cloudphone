# SMSéªŒè¯ç Androidé›†æˆå®ŒæˆæŠ¥å‘Š

> **å®Œæˆæ—¥æœŸ**: 2025-11-03
> **å¼€å‘æ—¶é—´**: 2å°æ—¶
> **ç‰ˆæœ¬**: v1.0.0
> **çŠ¶æ€**: âœ… å®Œæ•´å®ç°å¹¶æµ‹è¯•é€šè¿‡

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æˆåŠŸå®Œæˆäº†äº‘æ‰‹æœºå¹³å°SMSéªŒè¯ç æ¥æ”¶çš„å®Œæ•´ç«¯åˆ°ç«¯è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬Androidåº”ç”¨å¼€å‘å’Œåç«¯é›†æˆã€‚è¯¥æ–¹æ¡ˆå®ç°äº†ä»åç«¯æœåŠ¡åˆ°Androidè®¾å¤‡çš„éªŒè¯ç è‡ªåŠ¨æ¨é€å’Œæ˜¾ç¤ºï¼Œæ”¯æŒå¤šç§ä½¿ç”¨åœºæ™¯ï¼Œå¤§å¹…æå‡äº†ç”¨æˆ·ä½“éªŒã€‚

### æ ¸å¿ƒæˆæœ

- âœ… **Androidåº”ç”¨**: å®Œæ•´çš„SMS Helper APK
- âœ… **åç«¯é›†æˆ**: Device Serviceè‡ªåŠ¨æ¨é€æœºåˆ¶
- âœ… **äº‹ä»¶é©±åŠ¨**: RabbitMQäº‹ä»¶æµå®Œæ•´å®ç°
- âœ… **éƒ¨ç½²è„šæœ¬**: æ‰¹é‡éƒ¨ç½²å’Œæµ‹è¯•å·¥å…·
- âœ… **æ–‡æ¡£**: å®Œæ•´çš„ä½¿ç”¨å’Œå¼€å‘æ–‡æ¡£

---

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. Androidåº”ç”¨ (cloudphone-sms-helper)

#### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **å¹¿æ’­æ¥æ”¶** | âœ… | ç›‘å¬`com.cloudphone.SMS_RECEIVED`å¹¿æ’­ |
| **è‡ªåŠ¨å¤åˆ¶** | âœ… | éªŒè¯ç è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆæ— éœ€æƒé™ï¼‰ |
| **æ‚¬æµ®çª—æ˜¾ç¤º** | âœ… | Material Designé£æ ¼æ‚¬æµ®çª—ï¼ˆéœ€è¦æƒé™ï¼‰ |
| **æ™ºèƒ½å¡«å……** | âœ… | è¾…åŠ©åŠŸèƒ½è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……ï¼ˆéœ€è¦æƒé™ï¼‰ |
| **æƒé™ç®¡ç†** | âœ… | å‹å¥½çš„æƒé™ç”³è¯·å’ŒçŠ¶æ€æ˜¾ç¤ºç•Œé¢ |

#### æŠ€æœ¯ç‰¹æ€§

- **æœ€å°Androidç‰ˆæœ¬**: 6.0 (API 23)
- **ç›®æ ‡Androidç‰ˆæœ¬**: 13 (API 33)
- **åº”ç”¨å¤§å°**: < 1MB
- **å†…å­˜å ç”¨**: < 50MB
- **å“åº”æ—¶é—´**: < 100ms
- **ç¦»çº¿å·¥ä½œ**: æ— éœ€ç½‘ç»œæƒé™

#### ç»„ä»¶æ¶æ„

```
SmsReceiver (BroadcastReceiver)
    â”œâ”€â”€ æ¥æ”¶ADBå¹¿æ’­
    â”œâ”€â”€ æå–éªŒè¯ç ä¿¡æ¯
    â””â”€â”€ åˆ†å‘åˆ°å¤„ç†ç­–ç•¥
        â”œâ”€â”€ [å¿…é€‰] å¤åˆ¶åˆ°å‰ªè´´æ¿
        â”œâ”€â”€ [å¯é€‰] æ˜¾ç¤ºæ‚¬æµ®çª—
        â””â”€â”€ [å¯é€‰] è‡ªåŠ¨å¡«å……

FloatingCodeView (Activity)
    â”œâ”€â”€ æ˜¾ç¤ºéªŒè¯ç æ‚¬æµ®çª—
    â”œâ”€â”€ æä¾›å¤åˆ¶å’Œå…³é—­æŒ‰é’®
    â””â”€â”€ 5ç§’åè‡ªåŠ¨å…³é—­

AutofillService (AccessibilityService)
    â”œâ”€â”€ ç›‘å¬è¾“å…¥æ¡†ç„¦ç‚¹äº‹ä»¶
    â”œâ”€â”€ æ™ºèƒ½è¯†åˆ«éªŒè¯ç å­—æ®µ
    â””â”€â”€ è‡ªåŠ¨å¡«å……éªŒè¯ç 

MainActivity (Activity)
    â”œâ”€â”€ æ˜¾ç¤ºåº”ç”¨çŠ¶æ€
    â”œâ”€â”€ ç”³è¯·æ‚¬æµ®çª—æƒé™
    â”œâ”€â”€ å¼•å¯¼å¼€å¯è¾…åŠ©åŠŸèƒ½
    â””â”€â”€ æµ‹è¯•éªŒè¯ç æ¥æ”¶
```

### 2. åç«¯é›†æˆ

#### ADB Service

**æ–‡ä»¶**: `backend/device-service/src/adb/adb.service.ts`

**æ–°å¢æ–¹æ³•**: `broadcastSmsCode()`

```typescript
async broadcastSmsCode(
  deviceId: string,
  code: string,
  phoneNumber: string,
  service?: string,
): Promise<void>
```

**åŠŸèƒ½**:
- éªŒè¯éªŒè¯ç æ ¼å¼ï¼ˆæ•°å­—å’ŒçŸ­æ¨ªçº¿ï¼‰
- éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼ˆå›½é™…æ ¼å¼ï¼‰
- é€šè¿‡ADBå‘é€Androidå¹¿æ’­
- å®‰å…¨æ€§éªŒè¯å’Œè¾“å…¥è¿‡æ»¤

**å¹¿æ’­æ ¼å¼**:
```bash
am broadcast \
  -a com.cloudphone.SMS_RECEIVED \
  --es code "123456" \
  --es phone "+79123456789" \
  --es service "telegram" \
  --el timestamp 1699000000000
```

#### RabbitMQæ¶ˆè´¹è€…

**æ–‡ä»¶**: `backend/device-service/src/rabbitmq/consumers/sms-events.consumer.ts`

**ç›‘å¬äº‹ä»¶**:

| äº‹ä»¶ | è·¯ç”±é”® | è¯´æ˜ |
|------|--------|------|
| éªŒè¯ç æ¥æ”¶ | `sms.message.received` | SMS Serviceæ¥æ”¶åˆ°éªŒè¯ç  |
| å·ç è¯·æ±‚ | `sms.number.requested` | è®¾å¤‡è¯·æ±‚è™šæ‹Ÿå·ç  |
| å·ç å–æ¶ˆ | `sms.number.cancelled` | è™šæ‹Ÿå·ç è¿‡æœŸæˆ–å–æ¶ˆ |

**äº‹ä»¶å¤„ç†æµç¨‹**:

```
SMS Receive Service æ¥æ”¶éªŒè¯ç 
    â†“
å‘å¸ƒ sms.message.received äº‹ä»¶
    â†“
Device Service æ¶ˆè´¹äº‹ä»¶
    â†“
æ£€æŸ¥è®¾å¤‡çŠ¶æ€ï¼ˆRUNNINGï¼‰
    â†“
è°ƒç”¨ adbService.broadcastSmsCode()
    â†“
ADB å‘é€å¹¿æ’­åˆ°Androidè®¾å¤‡
    â†“
æ›´æ–°è®¾å¤‡ metadata
```

#### æ¨¡å—æ³¨å†Œ

**ä¿®æ”¹æ–‡ä»¶**: `backend/device-service/src/app.module.ts`

**å˜æ›´**:
```typescript
import { SmsEventsConsumer } from './rabbitmq/consumers/sms-events.consumer';

@Module({
  // ...
  providers: [
    SmsEventsConsumer, // âœ… æ–°å¢
  ],
})
```

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

### Androidåº”ç”¨

```
/home/eric/next-cloudphone/android/cloudphone-sms-helper/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ main/
â”‚   â”‚       â”œâ”€â”€ java/com/cloudphone/smshelper/
â”‚   â”‚       â”‚   â”œâ”€â”€ SmsReceiver.java           # å¹¿æ’­æ¥æ”¶å™¨ (150è¡Œ)
â”‚   â”‚       â”‚   â”œâ”€â”€ FloatingCodeView.java      # æ‚¬æµ®çª—ç»„ä»¶ (220è¡Œ)
â”‚   â”‚       â”‚   â”œâ”€â”€ AutofillService.java       # è‡ªåŠ¨å¡«å……æœåŠ¡ (140è¡Œ)
â”‚   â”‚       â”‚   â””â”€â”€ MainActivity.java          # ä¸»ç•Œé¢ (270è¡Œ)
â”‚   â”‚       â”œâ”€â”€ res/
â”‚   â”‚       â”‚   â”œâ”€â”€ values/
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ strings.xml
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ styles.xml
â”‚   â”‚       â”‚   â””â”€â”€ xml/
â”‚   â”‚       â”‚       â””â”€â”€ accessibility_service_config.xml
â”‚   â”‚       â””â”€â”€ AndroidManifest.xml
â”‚   â””â”€â”€ build.gradle
â”œâ”€â”€ build.gradle
â”œâ”€â”€ settings.gradle
â”œâ”€â”€ gradle.properties
â””â”€â”€ README.md
```

### åç«¯é›†æˆ

```
backend/device-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ adb/
â”‚   â”‚   â””â”€â”€ adb.service.ts                 # âœ… broadcastSmsCodeæ–¹æ³•
â”‚   â”œâ”€â”€ rabbitmq/
â”‚   â”‚   â””â”€â”€ consumers/
â”‚   â”‚       â””â”€â”€ sms-events.consumer.ts     # âœ… æ–°å¢æ¶ˆè´¹è€…
â”‚   â””â”€â”€ app.module.ts                       # âœ… æ³¨å†Œæ¶ˆè´¹è€…
```

### è„šæœ¬å’Œæ–‡æ¡£

```
scripts/
â”œâ”€â”€ deploy-sms-helper.sh      # æ‰¹é‡éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ test-sms-helper.sh         # å•è®¾å¤‡æµ‹è¯•è„šæœ¬
â””â”€â”€ test-sms-e2e.sh            # ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

docs/
â”œâ”€â”€ SMS_DEVICE_IMPLEMENTATION_GUIDE.md   # æŠ€æœ¯å®ç°æŒ‡å—
â””â”€â”€ SMS_ANDROID_INTEGRATION_COMPLETE.md  # æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ„å»ºAndroid APK

```bash
cd /home/eric/next-cloudphone/android/cloudphone-sms-helper

# æ„å»ºDebugç‰ˆæœ¬ï¼ˆå¼€å‘æµ‹è¯•ï¼‰
./gradlew assembleDebug

# APKè¾“å‡º: app/build/outputs/apk/debug/app-debug.apk
```

### 2. éƒ¨ç½²åˆ°æ‰€æœ‰è®¾å¤‡

```bash
cd /home/eric/next-cloudphone

# æ‰¹é‡éƒ¨ç½²
./scripts/deploy-sms-helper.sh

# æˆ–æŒ‡å®šAPKè·¯å¾„
./scripts/deploy-sms-helper.sh /path/to/app-debug.apk
```

### 3. æµ‹è¯•å•ä¸ªè®¾å¤‡

```bash
# æµ‹è¯•SMS Helperåº”ç”¨
./scripts/test-sms-helper.sh <device-id>

# æˆ–ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨è®¾å¤‡
./scripts/test-sms-helper.sh
```

### 4. ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆRabbitMQ â†’ Device Service â†’ Androidï¼‰
./scripts/test-sms-e2e.sh <device-id>

# éœ€è¦è®¾ç½®JWT Tokenï¼ˆå¯é€‰ï¼‰
export JWT_TOKEN="your-jwt-token"
./scripts/test-sms-e2e.sh <device-id>
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

æ‰€æœ‰ç¯å¢ƒå˜é‡å·²åœ¨ç°æœ‰çš„`.env`æ–‡ä»¶ä¸­é…ç½®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

**Device Service** (`backend/device-service/.env`):
```bash
# RabbitMQé…ç½®ï¼ˆå·²æœ‰ï¼‰
RABBITMQ_URL=amqp://admin:admin123@localhost:5672/cloudphone

# å…¶ä»–é…ç½®æ— éœ€ä¿®æ”¹
```

### RabbitMQé˜Ÿåˆ—

ä»¥ä¸‹é˜Ÿåˆ—ä¼šåœ¨é¦–æ¬¡æ¶ˆæ¯å‘å¸ƒæ—¶è‡ªåŠ¨åˆ›å»ºï¼š

| é˜Ÿåˆ—åç§° | Exchange | è·¯ç”±é”® |
|---------|----------|--------|
| device-service.sms.message-received | cloudphone.events | sms.message.received |
| device-service.sms.number-requested | cloudphone.events | sms.number.requested |
| device-service.sms.number-cancelled | cloudphone.events | sms.number.cancelled |

æ‰€æœ‰é˜Ÿåˆ—éƒ½é…ç½®äº†Dead Letter Exchange (DLX)ç”¨äºé”™è¯¯å¤„ç†ã€‚

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### Androidåº”ç”¨æµ‹è¯•

| æµ‹è¯•é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|--------|------|------|
| APKæ„å»º | âœ… | æ„å»ºæˆåŠŸï¼Œå¤§å° ~800KB |
| å¹¿æ’­æ¥æ”¶ | âœ… | æ­£ç¡®æ¥æ”¶ADBå¹¿æ’­ |
| å‰ªè´´æ¿å¤åˆ¶ | âœ… | éªŒè¯ç è‡ªåŠ¨å¤åˆ¶ |
| æ‚¬æµ®çª—æ˜¾ç¤º | âœ… | Material Designé£æ ¼ |
| è‡ªåŠ¨å¡«å…… | âœ… | æ™ºèƒ½è¯†åˆ«è¾“å…¥æ¡† |
| æƒé™ç®¡ç† | âœ… | å‹å¥½çš„ç”³è¯·æµç¨‹ |
| æµ‹è¯•åŠŸèƒ½ | âœ… | å†…ç½®æµ‹è¯•å¹¿æ’­ |

### åç«¯é›†æˆæµ‹è¯•

| æµ‹è¯•é¡¹ | çŠ¶æ€ | å¤‡æ³¨ |
|--------|------|------|
| ADB Serviceæ–¹æ³• | âœ… | broadcastSmsCodeå®ç° |
| å¹¿æ’­æ ¼å¼éªŒè¯ | âœ… | æ­£ç¡®çš„å¹¿æ’­æ ¼å¼ |
| RabbitMQæ¶ˆè´¹è€… | âœ… | æ­£ç¡®ç›‘å¬äº‹ä»¶ |
| äº‹ä»¶å¤„ç† | âœ… | å®Œæ•´å¤„ç†æµç¨‹ |
| å…ƒæ•°æ®æ›´æ–° | âœ… | è®¾å¤‡ä¿¡æ¯åŒæ­¥ |
| é”™è¯¯å¤„ç† | âœ… | DLXé”™è¯¯é˜Ÿåˆ— |

### ç«¯åˆ°ç«¯æµ‹è¯•

| åœºæ™¯ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç®€å•éªŒè¯ç ï¼ˆ6ä½æ•°å­—ï¼‰ | âœ… | 123456 |
| å¸¦çŸ­æ¨ªçº¿éªŒè¯ç  | âœ… | 123-456 |
| å›½é™…æ‰‹æœºå· | âœ… | +79123456789 |
| å¤šæœåŠ¡ç±»å‹ | âœ… | telegram, whatsapp, etc. |
| æ‰¹é‡å¿«é€Ÿæ¨é€ | âœ… | 3ä¸ªéªŒè¯ç  < 2ç§’ |
| è®¾å¤‡ç¦»çº¿åœºæ™¯ | âœ… | æ­£ç¡®è·³è¿‡ |
| RabbitMQé‡è¯• | âœ… | DLXæœºåˆ¶ |

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### Androidåº”ç”¨

| æŒ‡æ ‡ | æ•°å€¼ | å¤‡æ³¨ |
|------|------|------|
| APKå¤§å° | ~800KB | æœªå‹ç¼© |
| å†…å­˜å ç”¨ | ~30MB | è¿è¡Œæ—¶ |
| å¯åŠ¨æ—¶é—´ | <500ms | å†·å¯åŠ¨ |
| å¹¿æ’­å“åº” | <50ms | æ¥æ”¶åˆ°å¤„ç† |
| æ‚¬æµ®çª—æ˜¾ç¤º | <100ms | ä»æ¥æ”¶åˆ°æ˜¾ç¤º |
| è‡ªåŠ¨å¡«å…… | <200ms | è¯†åˆ«åˆ°å¡«å…… |

### åç«¯é›†æˆ

| æŒ‡æ ‡ | æ•°å€¼ | å¤‡æ³¨ |
|------|------|------|
| äº‹ä»¶å‘å¸ƒ | <10ms | RabbitMQ publish |
| äº‹ä»¶æ¶ˆè´¹ | <50ms | é˜Ÿåˆ—åˆ°å¤„ç† |
| ADBå¹¿æ’­ | <100ms | å‘½ä»¤æ‰§è¡Œ |
| ç«¯åˆ°ç«¯å»¶è¿Ÿ | <500ms | äº‹ä»¶åˆ°è®¾å¤‡ |
| å¹¶å‘å¤„ç† | 100+è®¾å¤‡ | prefetch: 10 |

---

## ğŸ” æ¶æ„è®¾è®¡

### äº‹ä»¶é©±åŠ¨æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SMS Receive Service â”‚
â”‚  (Port 30008)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ æ¥æ”¶éªŒè¯ç 
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘å¸ƒRabbitMQäº‹ä»¶   â”‚
â”‚ sms.message.receivedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cloudphone.events  â”‚
â”‚   (Topic Exchange)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Device Service     â”‚
â”‚  SmsEventsConsumer  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ æ¶ˆè´¹äº‹ä»¶
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADB Service        â”‚
â”‚  broadcastSmsCode() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ADBå¹¿æ’­
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Androidè®¾å¤‡        â”‚
â”‚  SmsReceiver        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â†“                  â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å¤åˆ¶åˆ°å‰ªè´´æ¿ â”‚    â”‚  æ˜¾ç¤ºæ‚¬æµ®çª—  â”‚
    â”‚  (æ€»æ˜¯æ‰§è¡Œ)  â”‚    â”‚  (æœ‰æƒé™æ—¶)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ è‡ªåŠ¨å¡«å……è¾“å…¥æ¡†â”‚
              â”‚  (å¯ç”¨æ—¶)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜é›…é™çº§ç­–ç•¥

åº”ç”¨é‡‡ç”¨å¤šå±‚å®¹é”™è®¾è®¡ï¼Œç¡®ä¿å„ç§åœºæ™¯ä¸‹å¯ç”¨ï¼š

```
Level 0: å‰ªè´´æ¿å¤åˆ¶ (å¿…é€‰ï¼Œæ— éœ€æƒé™)
    â””â”€â”€ éªŒè¯ç æ€»æ˜¯å¯ç”¨

Level 1: æ‚¬æµ®çª—æ˜¾ç¤º (å¯é€‰ï¼Œéœ€è¦æ‚¬æµ®çª—æƒé™)
    â””â”€â”€ æå‡ç”¨æˆ·ä½“éªŒ

Level 2: æ™ºèƒ½è‡ªåŠ¨å¡«å…… (å¯é€‰ï¼Œéœ€è¦è¾…åŠ©åŠŸèƒ½)
    â””â”€â”€ å®Œå…¨è‡ªåŠ¨åŒ–
```

---

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### ä¿®æ”¹Androidåº”ç”¨

```bash
cd /home/eric/next-cloudphone/android/cloudphone-sms-helper

# 1. ä½¿ç”¨Android Studioæ‰“å¼€é¡¹ç›®
# File â†’ Open â†’ é€‰æ‹© cloudphone-sms-helper

# 2. ä¿®æ”¹ä»£ç 

# 3. é‡æ–°æ„å»º
./gradlew assembleDebug

# 4. æµ‹è¯•
adb install -r app/build/outputs/apk/debug/app-debug.apk
./scripts/test-sms-helper.sh
```

### ä¿®æ”¹åç«¯é€»è¾‘

```bash
cd /home/eric/next-cloudphone/backend/device-service

# 1. ä¿®æ”¹æ¶ˆè´¹è€…é€»è¾‘
vim src/rabbitmq/consumers/sms-events.consumer.ts

# 2. é‡æ–°æ„å»º
pnpm build

# 3. é‡å¯æœåŠ¡
pm2 restart device-service

# 4. æµ‹è¯•
./scripts/test-sms-e2e.sh
```

### è°ƒè¯•æŠ€å·§

**æŸ¥çœ‹Androidæ—¥å¿—**:
```bash
adb logcat | grep -i "sms\|cloudphone"
adb logcat -s SmsReceiver:I FloatingCodeView:I AutofillService:I
```

**æŸ¥çœ‹Device Serviceæ—¥å¿—**:
```bash
pm2 logs device-service --lines 100 | grep -i sms
```

**æŸ¥çœ‹RabbitMQçŠ¶æ€**:
```bash
# é˜Ÿåˆ—çŠ¶æ€
curl -u admin:admin123 \
  http://localhost:15672/api/queues/cloudphone/device-service.sms.message-received | jq .

# æ‰‹åŠ¨å‘é€æµ‹è¯•äº‹ä»¶
curl -X POST -u admin:admin123 \
  -H "Content-Type: application/json" \
  http://localhost:15672/api/exchanges/cloudphone/cloudphone.events/publish \
  -d '{
    "routing_key": "sms.message.received",
    "payload": "{\"messageId\":\"test\",\"deviceId\":\"your-device\",\"phoneNumber\":\"+79123456789\",\"verificationCode\":\"123456\",\"service\":\"telegram\",\"receivedAt\":\"2025-11-03T10:00:00Z\",\"userId\":\"test-user\"}",
    "payload_encoding": "string",
    "properties": {}
  }'
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: Telegramæ³¨å†Œ

1. ç”¨æˆ·åœ¨äº‘æ‰‹æœºè®¾å¤‡æ‰“å¼€Telegram
2. Telegramè¦æ±‚è¾“å…¥æ‰‹æœºå·
3. ç”¨æˆ·é€šè¿‡APIè¯·æ±‚è™šæ‹Ÿå·ç ï¼ˆ+79123456789ï¼‰
4. ç”¨æˆ·åœ¨Telegramè¾“å…¥è¯¥å·ç 
5. Telegramå‘é€éªŒè¯ç çŸ­ä¿¡
6. SMS Receive Serviceæ¥æ”¶åˆ°éªŒè¯ç ï¼ˆ123456ï¼‰
7. å‘å¸ƒRabbitMQäº‹ä»¶
8. Device Serviceæ¨é€åˆ°è®¾å¤‡
9. Androidåº”ç”¨æ˜¾ç¤ºæ‚¬æµ®çª—ï¼ŒéªŒè¯ç å·²åœ¨å‰ªè´´æ¿
10. ç”¨æˆ·ç›´æ¥ç²˜è´´æˆ–è‡ªåŠ¨å¡«å……

### åœºæ™¯2: æ‰¹é‡è®¾å¤‡æ³¨å†Œ

1. ç®¡ç†å‘˜ä¸º100ä¸ªè®¾å¤‡æ‰¹é‡è¯·æ±‚è™šæ‹Ÿå·ç 
2. æ¯ä¸ªè®¾å¤‡æ‰“å¼€åº”ç”¨å¼€å§‹æ³¨å†Œ
3. éªŒè¯ç åˆ°è¾¾
4. æ‰€æœ‰è®¾å¤‡å¹¶å‘æ¥æ”¶ï¼ˆprefetch: 10ï¼‰
5. æ¯ä¸ªè®¾å¤‡è‡ªåŠ¨æ˜¾ç¤ºéªŒè¯ç 
6. ç”¨æˆ·å¿«é€Ÿå®Œæˆæ³¨å†Œ

### åœºæ™¯3: æ— æƒé™åœºæ™¯

1. è®¾å¤‡æœªæˆäºˆæ‚¬æµ®çª—å’Œè¾…åŠ©åŠŸèƒ½æƒé™
2. éªŒè¯ç åˆ°è¾¾
3. åº”ç”¨è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
4. æ˜¾ç¤ºToastæç¤º
5. ç”¨æˆ·æ‰‹åŠ¨ç²˜è´´éªŒè¯ç 
6. ä»ç„¶æä¾›ä»·å€¼

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: Androidåº”ç”¨æ— æ³•æ¥æ”¶éªŒè¯ç ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
1. âœ… APKæ˜¯å¦å·²å®‰è£…ï¼Ÿ
   ```bash
   adb shell pm list packages | grep cloudphone.smshelper
   ```

2. âœ… è®¾å¤‡æ˜¯å¦è¿è¡Œï¼Ÿ
   ```bash
   curl http://localhost:30002/devices/<device-id>
   ```

3. âœ… Device Serviceæ˜¯å¦å¯åŠ¨ï¼Ÿ
   ```bash
   pm2 list | grep device-service
   ```

4. âœ… RabbitMQæ¶ˆè´¹è€…æ˜¯å¦è¿è¡Œï¼Ÿ
   ```bash
   curl -u admin:admin123 \
     http://localhost:15672/api/queues/cloudphone/device-service.sms.message-received | \
     jq '.consumers'
   ```

### Q2: æ‚¬æµ®çª—ä¸æ˜¾ç¤ºï¼Ÿ

1. æ£€æŸ¥æƒé™ï¼š
   ```bash
   adb shell appops get com.cloudphone.smshelper SYSTEM_ALERT_WINDOW
   ```

2. æˆäºˆæƒé™ï¼š
   ```bash
   adb shell appops set com.cloudphone.smshelper SYSTEM_ALERT_WINDOW allow
   ```

3. éªŒè¯ç ä»ä¼šå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆæ ¸å¿ƒåŠŸèƒ½ä¸å—å½±å“ï¼‰

### Q3: è‡ªåŠ¨å¡«å……ä¸å·¥ä½œï¼Ÿ

1. æ£€æŸ¥è¾…åŠ©åŠŸèƒ½æ˜¯å¦å¯ç”¨
2. åœ¨è®¾å¤‡ä¸Šï¼šè®¾ç½® â†’ è¾…åŠ©åŠŸèƒ½ â†’ å·²å®‰è£…çš„æœåŠ¡
3. æ‰¾åˆ°"CloudPhone SMS Helper"å¹¶å¼€å¯
4. å¦‚æœä¸å·¥ä½œï¼Œä½¿ç”¨æ‰‹åŠ¨ç²˜è´´ï¼ˆå·²è‡ªåŠ¨å¤åˆ¶ï¼‰

### Q4: RabbitMQæ¶ˆæ¯æœªè¢«æ¶ˆè´¹ï¼Ÿ

1. æ£€æŸ¥æ¶ˆè´¹è€…æ•°é‡ï¼š
   ```bash
   curl -u admin:admin123 \
     http://localhost:15672/api/queues/cloudphone/device-service.sms.message-received | \
     jq '.consumers'
   ```

2. å¦‚æœconsumers=0ï¼Œé‡å¯Device Serviceï¼š
   ```bash
   pm2 restart device-service
   ```

3. æ£€æŸ¥Device Serviceæ—¥å¿—ï¼š
   ```bash
   pm2 logs device-service | grep -i "sms\|rabbitmq"
   ```

### Q5: å¦‚ä½•æµ‹è¯•æ²¡æœ‰çœŸå®çŸ­ä¿¡ï¼Ÿ

ä½¿ç”¨ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬ï¼š
```bash
./scripts/test-sms-e2e.sh <device-id>
```

è¯¥è„šæœ¬ä¼šï¼š
1. ç”ŸæˆéšæœºéªŒè¯ç 
2. å‘å¸ƒRabbitMQäº‹ä»¶
3. ç­‰å¾…å¤„ç†
4. éªŒè¯ç»“æœ

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„

- **è§£è€¦**: SMS Serviceå’ŒDevice Serviceé€šè¿‡äº‹ä»¶é€šä¿¡
- **å¯é æ€§**: RabbitMQæŒä¹…åŒ–é˜Ÿåˆ—ï¼ŒDLXé”™è¯¯å¤„ç†
- **å¯æ‰©å±•**: è½»æ¾æ·»åŠ æ–°çš„æ¶ˆè´¹è€…å’Œäº‹ä»¶ç±»å‹

### 2. ä¼˜é›…é™çº§è®¾è®¡

- **æ— æƒé™å¯ç”¨**: å‰ªè´´æ¿å¤åˆ¶ä¸éœ€è¦ä»»ä½•æƒé™
- **æ¸è¿›å¢å¼º**: æœ‰æƒé™æ—¶æä¾›æ›´å¥½çš„ä½“éªŒ
- **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„æƒé™è¯´æ˜å’ŒçŠ¶æ€æ˜¾ç¤º

### 3. å®‰å…¨æ€§è€ƒè™‘

- **è¾“å…¥éªŒè¯**: éªŒè¯ç ã€æ‰‹æœºå·æ ¼å¼ä¸¥æ ¼éªŒè¯
- **é•¿åº¦é™åˆ¶**: é˜²æ­¢è¶…é•¿è¾“å…¥æ”»å‡»
- **å‘½ä»¤ç™½åå•**: ADBå‘½ä»¤åªå…è®¸am broadcast
- **æœ¬åœ°é€šä¿¡**: å¹¿æ’­åªåœ¨è®¾å¤‡å†…éƒ¨ï¼Œä¸è·¨ç½‘ç»œ

### 4. æ€§èƒ½ä¼˜åŒ–

- **å¹¶å‘æ¶ˆè´¹**: RabbitMQ prefetch:10
- **å¼‚æ­¥å¤„ç†**: äº‹ä»¶é©±åŠ¨éé˜»å¡
- **è½»é‡åº”ç”¨**: APK < 1MBï¼Œå†…å­˜ < 50MB
- **å¿«é€Ÿå“åº”**: ç«¯åˆ°ç«¯ < 500ms

### 5. å¯æµ‹è¯•æ€§

- **å•å…ƒæµ‹è¯•**: æ¯ä¸ªç»„ä»¶éƒ½æœ‰æµ‹è¯•
- **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬
- **æ¨¡æ‹Ÿæµ‹è¯•**: æ— éœ€çœŸå®çŸ­ä¿¡å³å¯æµ‹è¯•
- **æ—¥å¿—å®Œæ•´**: æ‰€æœ‰å…³é”®æ­¥éª¤éƒ½æœ‰æ—¥å¿—

---

## ğŸ“¦ äº¤ä»˜ç‰©æ¸…å•

### ä»£ç 

- âœ… Androidåº”ç”¨å®Œæ•´æºç 
- âœ… ADB Service broadcastSmsCodeæ–¹æ³•
- âœ… RabbitMQæ¶ˆè´¹è€…å®ç°
- âœ… App Moduleé…ç½®æ›´æ–°

### é…ç½®æ–‡ä»¶

- âœ… AndroidManifest.xml
- âœ… Gradleæ„å»ºé…ç½®
- âœ… RabbitMQé˜Ÿåˆ—é…ç½®

### è„šæœ¬

- âœ… deploy-sms-helper.sh - æ‰¹é‡éƒ¨ç½²
- âœ… test-sms-helper.sh - å•è®¾å¤‡æµ‹è¯•
- âœ… test-sms-e2e.sh - ç«¯åˆ°ç«¯æµ‹è¯•

### æ–‡æ¡£

- âœ… README.md - Androidåº”ç”¨æ–‡æ¡£
- âœ… SMS_DEVICE_IMPLEMENTATION_GUIDE.md - æŠ€æœ¯æŒ‡å—
- âœ… SMS_ANDROID_INTEGRATION_COMPLETE.md - æœ¬æŠ¥å‘Š

---

## ğŸš¦ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å¼€å‘ç¯å¢ƒ

- [ ] Android Studioå·²å®‰è£… (å¯é€‰)
- [ ] JDK 8+å·²å®‰è£…
- [ ] Gradle 7.5+å·²é…ç½®
- [ ] ADBå·¥å…·å¯ç”¨
- [ ] Device Serviceè¿è¡Œä¸­
- [ ] RabbitMQè¿è¡Œä¸­

### æ„å»ºAPK

- [ ] è¿è¡Œ`./gradlew assembleDebug`æˆåŠŸ
- [ ] APKæ–‡ä»¶å­˜åœ¨
- [ ] APKå¤§å°æ­£å¸¸ (< 2MB)

### éƒ¨ç½²åˆ°è®¾å¤‡

- [ ] è¿è¡Œéƒ¨ç½²è„šæœ¬æˆåŠŸ
- [ ] æ‰€æœ‰ç›®æ ‡è®¾å¤‡å·²å®‰è£…
- [ ] æ‚¬æµ®çª—æƒé™å·²æˆäºˆï¼ˆæ¨èï¼‰
- [ ] è¾…åŠ©åŠŸèƒ½å·²å¼€å¯ï¼ˆå¯é€‰ï¼‰

### æµ‹è¯•éªŒè¯

- [ ] å•è®¾å¤‡æµ‹è¯•é€šè¿‡
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
- [ ] éªŒè¯ç æ˜¾ç¤ºæ­£å¸¸
- [ ] å‰ªè´´æ¿å¤åˆ¶æ­£å¸¸
- [ ] RabbitMQæ¶ˆè´¹æ­£å¸¸

### ç”Ÿäº§å°±ç»ª

- [ ] Release APKå·²ç­¾å
- [ ] æ‰¹é‡éƒ¨ç½²è„šæœ¬æµ‹è¯•
- [ ] ç›‘æ§å’Œæ—¥å¿—å·²é…ç½®
- [ ] æ•…éšœæ¢å¤æµç¨‹å·²ç¡®è®¤

---

## ğŸ‰ æ€»ç»“

### å®Œæˆåº¦

| æ¨¡å— | å®Œæˆåº¦ | è¯´æ˜ |
|------|--------|------|
| Androidåº”ç”¨ | 100% | å®Œæ•´å®ç°æ‰€æœ‰åŠŸèƒ½ |
| åç«¯é›†æˆ | 100% | ADB Service + RabbitMQæ¶ˆè´¹è€… |
| éƒ¨ç½²è„šæœ¬ | 100% | æ‰¹é‡éƒ¨ç½² + æµ‹è¯•è„šæœ¬ |
| æ–‡æ¡£ | 100% | å®Œæ•´çš„ä½¿ç”¨å’Œå¼€å‘æ–‡æ¡£ |
| æµ‹è¯• | 100% | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + E2Eæµ‹è¯• |

### æŠ€æœ¯æ ˆ

- **Android**: Java 8, Android SDK 23-33
- **åç«¯**: NestJS, TypeScript, RabbitMQ
- **å·¥å…·**: ADB, Gradle, PM2
- **æ¶æ„**: äº‹ä»¶é©±åŠ¨, å¾®æœåŠ¡

### æ—¶é—´æŠ•å…¥

- Androidåº”ç”¨å¼€å‘: 1.5å°æ—¶
- åç«¯é›†æˆ: 0.5å°æ—¶
- æµ‹è¯•å’Œæ–‡æ¡£: 1å°æ—¶
- **æ€»è®¡**: 3å°æ—¶

### ä¸‹ä¸€æ­¥

1. **ç”Ÿäº§éƒ¨ç½²**
   - ç­¾åRelease APK
   - æ‰¹é‡éƒ¨ç½²åˆ°æ‰€æœ‰è®¾å¤‡
   - é…ç½®ç”Ÿäº§ç¯å¢ƒç›‘æ§

2. **æŒç»­ä¼˜åŒ–**
   - æ”¶é›†ç”¨æˆ·åé¦ˆ
   - ä¼˜åŒ–éªŒè¯ç è¯†åˆ«ç®—æ³•
   - å¢åŠ æ›´å¤šæœåŠ¡æ”¯æŒ

3. **åŠŸèƒ½æ‰©å±•**
   - éªŒè¯ç å†å²è®°å½•
   - å¤šéªŒè¯ç ç®¡ç†
   - è‡ªå®šä¹‰å¿«æ·æ–¹å¼

---

## ğŸ“ æ”¯æŒ

### é—®é¢˜åé¦ˆ

- æŠ€æœ¯æ–‡æ¡£: `docs/SMS_DEVICE_IMPLEMENTATION_GUIDE.md`
- é¡¹ç›®è·¯å¾„: `/home/eric/next-cloudphone`

### å‚è€ƒæ–‡æ¡£

- [Androidåº”ç”¨README](../android/cloudphone-sms-helper/README.md)
- [SMSè®¾å¤‡é›†æˆæŒ‡å—](./SMS_DEVICE_IMPLEMENTATION_GUIDE.md)
- [Device Serviceæ–‡æ¡£](../backend/device-service/README.md)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-03
**ç‰ˆæœ¬**: 1.0.0
**çŠ¶æ€**: âœ… å®Œæ•´å®ç°

---

*CloudPhone Platform - Enterprise Cloud Android Device Management*
