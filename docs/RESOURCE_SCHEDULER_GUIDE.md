# ğŸ”€ èµ„æºè°ƒåº¦ç³»ç»Ÿä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: 1.0.0
**æ›´æ–°æ—¶é—´**: 2025-10-20
**é€‚ç”¨ç¯å¢ƒ**: Device Service (NestJS)

---

## ğŸ“‘ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
4. [èŠ‚ç‚¹ç®¡ç†](#èŠ‚ç‚¹ç®¡ç†)
5. [è°ƒåº¦ç­–ç•¥](#è°ƒåº¦ç­–ç•¥)
6. [èµ„æºç›‘æ§](#èµ„æºç›‘æ§)
7. [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
9. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯èµ„æºè°ƒåº¦ç³»ç»Ÿï¼Ÿ

èµ„æºè°ƒåº¦ç³»ç»Ÿæ˜¯äº‘æ‰‹æœºå¹³å°çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£åœ¨å¤šä¸ªç‰©ç†èŠ‚ç‚¹ä¹‹é—´æ™ºèƒ½åˆ†é…è®¾å¤‡èµ„æºï¼Œå®ç°ï¼š

- ğŸŒ **å¤šèŠ‚ç‚¹ç®¡ç†**: ç»Ÿä¸€ç®¡ç†å¤šå°ç‰©ç†æœåŠ¡å™¨
- âš–ï¸ **è´Ÿè½½å‡è¡¡**: æ™ºèƒ½åˆ†é…è®¾å¤‡åˆ°æœ€ä¼˜èŠ‚ç‚¹
- ğŸ“Š **èµ„æºç›‘æ§**: å®æ—¶ç›‘æ§å„èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ
- ğŸ”„ **è‡ªåŠ¨æ¢å¤**: èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨è½¬ç§»è®¾å¤‡
- ğŸ“ˆ **å¼¹æ€§æ‰©å®¹**: æ”¯æŒåŠ¨æ€æ·»åŠ /ç§»é™¤èŠ‚ç‚¹

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è°ƒåº¦å™¨ (Scheduler)                 â”‚
â”‚   - 4ç§è°ƒåº¦ç­–ç•¥                             â”‚
â”‚   - èŠ‚ç‚¹è¯„åˆ†ç®—æ³•                            â”‚
â”‚   - é›†ç¾¤é‡å¹³è¡¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        èŠ‚ç‚¹ç®¡ç†å™¨ (Node Manager)             â”‚
â”‚   - èŠ‚ç‚¹æ³¨å†Œ/æ³¨é”€                           â”‚
â”‚   - æ ‡ç­¾å’Œæ±¡ç‚¹ç®¡ç†                          â”‚
â”‚   - ç»´æŠ¤æ¨¡å¼æ§åˆ¶                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       èµ„æºç›‘æ§å™¨ (Resource Monitor)          â”‚
â”‚   - å®æ—¶èµ„æºç›‘æ§ (æ¯30ç§’)                   â”‚
â”‚   - å¥åº·æ£€æŸ¥ (æ¯åˆ†é’Ÿ)                       â”‚
â”‚   - è´Ÿè½½åˆ†æ•°è®¡ç®—                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚          â”‚          â”‚            â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Node 1 â”‚ â”‚Node 2 â”‚ â”‚Node 3 â”‚  â”‚ Node 4 â”‚
   â”‚  50å°  â”‚ â”‚ 30å°  â”‚ â”‚ 20å°  â”‚  â”‚  10å°  â”‚
   â”‚Load:60 â”‚ â”‚Load:40â”‚ â”‚Load:20â”‚  â”‚Load:10 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¿«é€Ÿå¼€å§‹

### 1. æ³¨å†Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹

```bash
curl -X POST http://localhost:30002/scheduler/nodes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "name": "node-001",
    "hostname": "cloudphone-server-1",
    "ipAddress": "192.168.1.100",
    "dockerPort": 2375,
    "capacity": {
      "totalCpuCores": 32,
      "totalMemoryMB": 65536,
      "totalStorageGB": 1000,
      "maxDevices": 100
    },
    "labels": {
      "env": "prod",
      "region": "us-west",
      "gpu": "enabled"
    },
    "priority": 10
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": "node-uuid-xxx",
  "name": "node-001",
  "status": "online",
  "capacity": {...},
  "usage": {
    "usedCpuCores": 0,
    "usedMemoryMB": 0,
    "activeDevices": 0
  },
  "loadScore": 0
}
```

### 2. ä¸ºè®¾å¤‡é€‰æ‹©æœ€ä½³èŠ‚ç‚¹

```bash
curl -X POST http://localhost:30002/scheduler/schedule \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "cpuCores": 4,
    "memoryMB": 8192,
    "storageMB": 20480,
    "labels": {
      "type": "gaming"
    }
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "nodeId": "node-uuid-xxx",
  "nodeName": "node-001",
  "reason": "Best score: 95.60",
  "score": 95.60
}
```

### 3. æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```bash
curl http://localhost:30002/scheduler/resources/cluster-stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "nodes": {
    "total": 4,
    "online": 3,
    "offline": 1
  },
  "capacity": {
    "cpuCores": 128,
    "memoryMB": 262144,
    "storageGB": 4000,
    "maxDevices": 400
  },
  "usage": {
    "cpuCores": 48,
    "memoryMB": 98304,
    "devices": 120
  },
  "utilization": {
    "cpu": 37.5,
    "memory": 37.5,
    "devices": 30.0
  }
}
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### èŠ‚ç‚¹ (Node)

èŠ‚ç‚¹æ˜¯è¿è¡Œè®¾å¤‡çš„ç‰©ç†æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºã€‚

**èŠ‚ç‚¹å±æ€§**:
```typescript
{
  id: string;                    // èŠ‚ç‚¹ID
  name: string;                  // èŠ‚ç‚¹åç§°
  hostname: string;              // ä¸»æœºå
  ipAddress: string;             // IPåœ°å€
  dockerPort: number;            // Dockerç«¯å£
  status: NodeStatus;            // çŠ¶æ€

  // èµ„æºå®¹é‡
  capacity: {
    totalCpuCores: number;       // æ€»CPUæ ¸å¿ƒæ•°
    totalMemoryMB: number;       // æ€»å†…å­˜(MB)
    totalStorageGB: number;      // æ€»å­˜å‚¨(GB)
    maxDevices: number;          // æœ€å¤§è®¾å¤‡æ•°
  };

  // å½“å‰ä½¿ç”¨æƒ…å†µ
  usage: {
    usedCpuCores: number;        // å·²ç”¨CPU
    usedMemoryMB: number;        // å·²ç”¨å†…å­˜
    activeDevices: number;       // æ´»è·ƒè®¾å¤‡æ•°
    cpuUsagePercent: number;     // CPUä½¿ç”¨ç‡
    memoryUsagePercent: number;  // å†…å­˜ä½¿ç”¨ç‡
  };

  loadScore: number;             // è´Ÿè½½åˆ†æ•°(0-100)
  labels: Record<string, string>; // æ ‡ç­¾
  taints: Array<Taint>;          // æ±¡ç‚¹
  priority: number;              // ä¼˜å…ˆçº§
}
```

**èŠ‚ç‚¹çŠ¶æ€**:
- `online`: åœ¨çº¿ï¼Œå¯ä»¥è°ƒåº¦è®¾å¤‡
- `offline`: ç¦»çº¿ï¼Œä¸å¯ç”¨
- `maintenance`: ç»´æŠ¤æ¨¡å¼ï¼Œä¸æ¥å—æ–°è®¾å¤‡
- `draining`: æ’ç©ºæ¨¡å¼ï¼Œä¿æŒç°æœ‰è®¾å¤‡ä½†ä¸æ¥å—æ–°è®¾å¤‡

### è°ƒåº¦è¯·æ±‚ (Schedule Request)

```typescript
{
  cpuCores: number;              // æ‰€éœ€CPU
  memoryMB: number;              // æ‰€éœ€å†…å­˜
  storageMB?: number;            // æ‰€éœ€å­˜å‚¨
  labels?: Record<string, string>; // è®¾å¤‡æ ‡ç­¾ï¼ˆç”¨äºäº²å’Œæ€§ï¼‰
  tolerations?: string[];        // å®¹å¿çš„æ±¡ç‚¹
  preferredNode?: string;        // é¦–é€‰èŠ‚ç‚¹
}
```

### è´Ÿè½½åˆ†æ•° (Load Score)

è´Ÿè½½åˆ†æ•°æ˜¯ç»¼åˆè¯„ä¼°èŠ‚ç‚¹è´Ÿè½½çš„æŒ‡æ ‡ï¼ŒèŒƒå›´ 0-100ï¼š
- **0-30**: ä½è´Ÿè½½ï¼Œå¤§é‡å¯ç”¨èµ„æº
- **30-60**: ä¸­ç­‰è´Ÿè½½ï¼Œèµ„æºå……è¶³
- **60-80**: é«˜è´Ÿè½½ï¼Œèµ„æºç´§å¼ 
- **80-100**: æ»¡è½½æˆ–æ¥è¿‘æ»¡è½½

**è®¡ç®—å…¬å¼**:
```
LoadScore = CPUä½¿ç”¨ç‡ Ã— 0.3 + å†…å­˜ä½¿ç”¨ç‡ Ã— 0.3 + è®¾å¤‡æ•°ä½¿ç”¨ç‡ Ã— 0.4
```

---

## èŠ‚ç‚¹ç®¡ç†

### æ³¨å†ŒèŠ‚ç‚¹

**API**: `POST /scheduler/nodes`

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
  "name": "node-002",
  "hostname": "cloudphone-server-2",
  "ipAddress": "192.168.1.101",
  "dockerPort": 2375,
  "capacity": {
    "totalCpuCores": 64,
    "totalMemoryMB": 131072,
    "totalStorageGB": 2000,
    "maxDevices": 200
  },
  "labels": {
    "env": "prod",
    "region": "us-east",
    "tier": "high-performance"
  },
  "region": "us-east",
  "zone": "us-east-1a",
  "priority": 20
}
```

**æœ€ä½³å®è·µ**:
- ä½¿ç”¨æè¿°æ€§çš„èŠ‚ç‚¹åç§°
- è®¾ç½®åˆç†çš„èµ„æºå®¹é‡ï¼ˆç•™ 10-20% ä½™é‡ï¼‰
- ä½¿ç”¨æ ‡ç­¾æ ‡è®°èŠ‚ç‚¹ç‰¹æ€§
- æ ¹æ®ç¡¬ä»¶æ€§èƒ½è®¾ç½®ä¼˜å…ˆçº§

### è·å–èŠ‚ç‚¹åˆ—è¡¨

**API**: `GET /scheduler/nodes?status=online`

**æŸ¥è¯¢å‚æ•°**:
- `status`: è¿‡æ»¤èŠ‚ç‚¹çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

**å“åº”**: èŠ‚ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§å’Œè´Ÿè½½æ’åº

### æ›´æ–°èŠ‚ç‚¹

**API**: `PUT /scheduler/nodes/:id`

**å¯æ›´æ–°å­—æ®µ**:
```json
{
  "status": "maintenance",
  "capacity": {
    "maxDevices": 150
  },
  "labels": {
    "maintenance": "scheduled"
  },
  "priority": 15
}
```

### åˆ é™¤èŠ‚ç‚¹

**API**: `DELETE /scheduler/nodes/:id`

**è¦æ±‚**:
- èŠ‚ç‚¹ä¸Šæ²¡æœ‰è¿è¡Œä¸­çš„è®¾å¤‡
- æˆ–å…ˆä½¿ç”¨æ’ç©ºæ¨¡å¼è¿ç§»è®¾å¤‡

### èŠ‚ç‚¹æ ‡ç­¾ç®¡ç†

**æ·»åŠ /æ›´æ–°æ ‡ç­¾**:
```bash
curl -X PUT http://localhost:30002/scheduler/nodes/{nodeId}/labels \
  -H "Content-Type: application/json" \
  -d '{
    "gpu": "nvidia-rtx3090",
    "storage-type": "nvme",
    "network": "10gbps"
  }'
```

**åˆ é™¤æ ‡ç­¾**:
```bash
curl -X DELETE http://localhost:30002/scheduler/nodes/{nodeId}/labels/gpu
```

**ç”¨é€”**:
- æ ‡è®°èŠ‚ç‚¹ç¡¬ä»¶ç‰¹æ€§
- å®ç°äº²å’Œæ€§è°ƒåº¦
- æŒ‰æ ‡ç­¾æŸ¥è¯¢èŠ‚ç‚¹

### èŠ‚ç‚¹æ±¡ç‚¹ç®¡ç†

æ±¡ç‚¹ç”¨äºæ’æ–¥æŸäº›è®¾å¤‡è°ƒåº¦åˆ°èŠ‚ç‚¹ã€‚

**æ·»åŠ æ±¡ç‚¹**:
```bash
curl -X POST http://localhost:30002/scheduler/nodes/{nodeId}/taints \
  -H "Content-Type: application/json" \
  -d '{
    "key": "gpu-required",
    "value": "true",
    "effect": "NoSchedule"
  }'
```

**æ±¡ç‚¹æ•ˆæœ**:
- `NoSchedule`: ä¸å…è®¸è°ƒåº¦ï¼ˆé™¤éè®¾å¤‡å®¹å¿è¯¥æ±¡ç‚¹ï¼‰
- `PreferNoSchedule`: å°½é‡ä¸è°ƒåº¦
- `NoExecute`: ä¸å…è®¸è°ƒåº¦ï¼Œä¸”é©±é€ç°æœ‰è®¾å¤‡

**ä½¿ç”¨åœºæ™¯**:
- GPU èŠ‚ç‚¹ï¼šåªæ¥å—éœ€è¦ GPU çš„è®¾å¤‡
- ä¸“ç”¨èŠ‚ç‚¹ï¼šé¢„ç•™ç»™ç‰¹å®šç±»å‹çš„è®¾å¤‡
- ç»´æŠ¤å‰ï¼šæ ‡è®°èŠ‚ç‚¹ï¼Œé˜²æ­¢æ–°è®¾å¤‡è°ƒåº¦

---

## è°ƒåº¦ç­–ç•¥

è°ƒåº¦å™¨æ”¯æŒ 4 ç§ç­–ç•¥ï¼Œæ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©ã€‚

### 1. Balancedï¼ˆå‡è¡¡ç­–ç•¥ï¼‰- é»˜è®¤

**ç‰¹ç‚¹**: é€‰æ‹©è´Ÿè½½æœ€å‡è¡¡çš„èŠ‚ç‚¹

**é€‚ç”¨åœºæ™¯**:
- é€šç”¨åœºæ™¯
- å¸Œæœ›å„èŠ‚ç‚¹è´Ÿè½½å‡è¡¡
- é¿å…æŸäº›èŠ‚ç‚¹è¿‡è½½

**è¯„åˆ†è§„åˆ™**:
- è®¡ç®—è°ƒåº¦åå„èµ„æºï¼ˆCPUã€å†…å­˜ã€è®¾å¤‡æ•°ï¼‰çš„ä½¿ç”¨ç‡
- ä½¿ç”¨ç‡è¶Šå‡è¡¡ï¼Œå¾—åˆ†è¶Šé«˜
- è€ƒè™‘èŠ‚ç‚¹ä¼˜å…ˆçº§

**è®¾ç½®æ–¹æ³•**:
```bash
curl -X POST http://localhost:30002/scheduler/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "balanced"}'
```

### 2. Binpackï¼ˆè£…ç®±ç­–ç•¥ï¼‰

**ç‰¹ç‚¹**: ä¼˜å…ˆå¡«æ»¡èŠ‚ç‚¹ï¼ŒèŠ‚çœèµ„æº

**é€‚ç”¨åœºæ™¯**:
- èŠ‚çœæˆæœ¬ï¼Œå‡å°‘ä½¿ç”¨çš„èŠ‚ç‚¹æ•°é‡
- äº‘ç¯å¢ƒï¼ŒæŒ‰èŠ‚ç‚¹ä»˜è´¹
- ä¾¿äºç¼©å®¹å’Œç»´æŠ¤

**è¯„åˆ†è§„åˆ™**:
- ä½¿ç”¨ç‡è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜
- ä¼˜å…ˆé€‰æ‹©å·²æœ‰è®¾å¤‡çš„èŠ‚ç‚¹
- å°½å¯èƒ½å¡«æ»¡èŠ‚ç‚¹

**è®¾ç½®æ–¹æ³•**:
```bash
curl -X POST http://localhost:30002/scheduler/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "binpack"}'
```

### 3. Spreadï¼ˆåˆ†æ•£ç­–ç•¥ï¼‰

**ç‰¹ç‚¹**: å°½é‡åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹

**é€‚ç”¨åœºæ™¯**:
- æé«˜å¯ç”¨æ€§
- é¿å…å•ç‚¹æ•…éšœå½±å“è¿‡å¤šè®¾å¤‡
- æµ‹è¯•ç¯å¢ƒï¼Œéš”ç¦»ä¸åŒé¡¹ç›®

**è¯„åˆ†è§„åˆ™**:
- ä½¿ç”¨ç‡è¶Šä½ï¼Œå¾—åˆ†è¶Šé«˜
- ä¼˜å…ˆé€‰æ‹©ç©ºé—²èŠ‚ç‚¹
- å°½å¯èƒ½åˆ†æ•£è®¾å¤‡

**è®¾ç½®æ–¹æ³•**:
```bash
curl -X POST http://localhost:30002/scheduler/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "spread"}'
```

### 4. LeastLoadedï¼ˆæœ€å°è´Ÿè½½ç­–ç•¥ï¼‰

**ç‰¹ç‚¹**: é€‰æ‹©è´Ÿè½½æœ€å°çš„èŠ‚ç‚¹

**é€‚ç”¨åœºæ™¯**:
- æ€§èƒ½æ•æ„Ÿçš„åº”ç”¨
- é¿å…èµ„æºç«äº‰
- çªå‘æµé‡åœºæ™¯

**è¯„åˆ†è§„åˆ™**:
- ç›´æ¥ä½¿ç”¨è´Ÿè½½åˆ†æ•°
- è´Ÿè½½è¶Šä½ï¼Œå¾—åˆ†è¶Šé«˜
- ç®€å•ç›´æ¥

**è®¾ç½®æ–¹æ³•**:
```bash
curl -X POST http://localhost:30002/scheduler/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "least_loaded"}'
```

### ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | èµ„æºåˆ©ç”¨ç‡ | å¯ç”¨æ€§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|------|-----------|--------|------|---------|
| Balanced | â­â­â­ | â­â­â­ | â­â­â­ | é€šç”¨ |
| Binpack | â­â­â­â­â­ | â­â­ | â­â­ | èŠ‚çœæˆæœ¬ |
| Spread | â­â­ | â­â­â­â­â­ | â­â­â­â­ | é«˜å¯ç”¨ |
| LeastLoaded | â­â­â­ | â­â­â­ | â­â­â­â­â­ | é«˜æ€§èƒ½ |

---

## èµ„æºç›‘æ§

### è‡ªåŠ¨ç›‘æ§

ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹ç›‘æ§ä»»åŠ¡ï¼š

**èµ„æºæ›´æ–°ï¼ˆæ¯30ç§’ï¼‰**:
- æ›´æ–°æ‰€æœ‰åœ¨çº¿èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µ
- è®¡ç®—è´Ÿè½½åˆ†æ•°
- æ›´æ–°å¿ƒè·³æ—¶é—´

**å¥åº·æ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿï¼‰**:
- æ£€æŸ¥èŠ‚ç‚¹å¿ƒè·³
- è¶…è¿‡3åˆ†é’Ÿæ— å¿ƒè·³ â†’ æ ‡è®°ä¸ºç¦»çº¿
- å¥åº·æ£€æŸ¥å¤±è´¥5æ¬¡ â†’ æ ‡è®°ä¸ºç¦»çº¿

### æ‰‹åŠ¨è§¦å‘

**æ›´æ–°å•ä¸ªèŠ‚ç‚¹**:
```bash
curl -X POST http://localhost:30002/scheduler/resources/update/{nodeId}
```

### é›†ç¾¤ç»Ÿè®¡

**è·å–é›†ç¾¤èµ„æºç»Ÿè®¡**:
```bash
curl http://localhost:30002/scheduler/resources/cluster-stats
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "nodes": {
    "total": 5,
    "online": 4,
    "offline": 1
  },
  "capacity": {
    "cpuCores": 160,
    "memoryMB": 327680,
    "storageGB": 5000,
    "maxDevices": 500
  },
  "usage": {
    "cpuCores": 72,
    "memoryMB": 147456,
    "storageGB": 1500,
    "devices": 180
  },
  "utilization": {
    "cpu": 45.0,
    "memory": 45.0,
    "storage": 30.0,
    "devices": 36.0
  }
}
```

### è°ƒåº¦ç»Ÿè®¡

**è·å–è°ƒåº¦ç»Ÿè®¡**:
```bash
curl http://localhost:30002/scheduler/stats
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "totalNodes": 5,
  "onlineNodes": 4,
  "offlineNodes": 1,
  "averageLoad": 42.5,
  "minLoad": 15.0,
  "maxLoad": 75.0,
  "strategy": "balanced"
}
```

---

## é«˜çº§åŠŸèƒ½

### é›†ç¾¤é‡å¹³è¡¡

å½“é›†ç¾¤è´Ÿè½½ä¸å‡æ—¶ï¼Œç³»ç»Ÿå¯ä»¥ç”Ÿæˆè¿ç§»è®¡åˆ’ã€‚

**API**: `POST /scheduler/rebalance`

**å·¥ä½œåŸç†**:
1. è®¡ç®—é›†ç¾¤å¹³å‡è´Ÿè½½
2. æ‰¾å‡ºè´Ÿè½½è¿‡é«˜çš„èŠ‚ç‚¹ï¼ˆè¶…è¿‡å¹³å‡å€¼20%ä»¥ä¸Šï¼‰
3. æ‰¾å‡ºè´Ÿè½½è¾ƒä½çš„èŠ‚ç‚¹ï¼ˆä½äºå¹³å‡å€¼20%ä»¥ä¸‹ï¼‰
4. ç”Ÿæˆè®¾å¤‡è¿ç§»è®¡åˆ’

**å“åº”ç¤ºä¾‹**:
```json
{
  "migrationsNeeded": 8,
  "migrationPlan": [
    {
      "deviceId": "device-001",
      "from": "node-001",
      "to": "node-003"
    },
    {
      "deviceId": "device-002",
      "from": "node-001",
      "to": "node-004"
    }
  ]
}
```

**æ³¨æ„**: ç³»ç»Ÿåªç”Ÿæˆè®¡åˆ’ï¼Œå®é™…è¿ç§»éœ€è¦æ‰‹åŠ¨æ‰§è¡Œæˆ–é€šè¿‡è„šæœ¬è‡ªåŠ¨åŒ–ã€‚

### ç»´æŠ¤æ¨¡å¼

**è®¾ç½®ç»´æŠ¤æ¨¡å¼**:
```bash
curl -X POST http://localhost:30002/scheduler/nodes/{nodeId}/maintenance \
  -H "Content-Type: application/json" \
  -d '{"enable": true}'
```

**ç‰¹ç‚¹**:
- èŠ‚ç‚¹çŠ¶æ€å˜ä¸º `maintenance`
- ä¸æ¥å—æ–°è®¾å¤‡è°ƒåº¦
- ç°æœ‰è®¾å¤‡ç»§ç»­è¿è¡Œ
- é€‚åˆçŸ­æœŸç»´æŠ¤

### æ’ç©ºæ¨¡å¼

**æ’ç©ºèŠ‚ç‚¹**:
```bash
curl -X POST http://localhost:30002/scheduler/nodes/{nodeId}/drain
```

**ç‰¹ç‚¹**:
- èŠ‚ç‚¹çŠ¶æ€å˜ä¸º `draining`
- ä¸æ¥å—æ–°è®¾å¤‡
- å»ºè®®è¿ç§»ç°æœ‰è®¾å¤‡
- é€‚åˆé•¿æœŸç»´æŠ¤æˆ–ä¸‹çº¿

### äº²å’Œæ€§è°ƒåº¦

ä½¿ç”¨æ ‡ç­¾å®ç°äº²å’Œæ€§è°ƒåº¦ã€‚

**ç¤ºä¾‹ 1: GPU è®¾å¤‡äº²å’Œ**:
```bash
# 1. ä¸º GPU èŠ‚ç‚¹æ·»åŠ æ ‡ç­¾
curl -X PUT http://localhost:30002/scheduler/nodes/node-001/labels \
  -d '{"gpu": "nvidia-rtx3090"}'

# 2. è°ƒåº¦æ—¶æŒ‡å®šæ ‡ç­¾éœ€æ±‚
curl -X POST http://localhost:30002/scheduler/schedule \
  -d '{
    "cpuCores": 4,
    "memoryMB": 8192,
    "labels": {"gpu-required": "true"},
    "preferredNode": "node-001"
  }'
```

**ç¤ºä¾‹ 2: åŒºåŸŸäº²å’Œ**:
```bash
# è·å–æŒ‡å®šåŒºåŸŸçš„èŠ‚ç‚¹
curl "http://localhost:30002/scheduler/nodes/by-region/us-west"

# è·å–æŒ‡å®šæ ‡ç­¾çš„èŠ‚ç‚¹
curl "http://localhost:30002/scheduler/nodes/by-label?key=env&value=prod"
```

### æ‰¹é‡è°ƒåº¦

ä¸€æ¬¡æ€§ä¸ºå¤šä¸ªè®¾å¤‡é€‰æ‹©èŠ‚ç‚¹ã€‚

**API**: `POST /scheduler/schedule/batch`

**è¯·æ±‚ç¤ºä¾‹**:
```json
[
  { "cpuCores": 4, "memoryMB": 8192 },
  { "cpuCores": 2, "memoryMB": 4096 },
  { "cpuCores": 4, "memoryMB": 8192 }
]
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "total": 3,
  "scheduled": 3,
  "results": [
    {
      "device": "device-0",
      "nodeId": "node-001",
      "nodeName": "node-001",
      "score": 85.0
    },
    {
      "device": "device-1",
      "nodeId": "node-002",
      "nodeName": "node-002",
      "score": 90.0
    },
    {
      "device": "device-2",
      "nodeId": "node-001",
      "nodeName": "node-001",
      "score": 80.0
    }
  ]
}
```

---

## æœ€ä½³å®è·µ

### 1. èŠ‚ç‚¹è§„åˆ’

**ç¡¬ä»¶é…ç½®å»ºè®®**:
```
å°å‹èŠ‚ç‚¹:
- CPU: 16-32 æ ¸
- å†…å­˜: 64-128 GB
- å­˜å‚¨: 500-1000 GB NVMe SSD
- æœ€å¤§è®¾å¤‡: 50-100 å°

å¤§å‹èŠ‚ç‚¹:
- CPU: 64-128 æ ¸
- å†…å­˜: 256-512 GB
- å­˜å‚¨: 2-4 TB NVMe SSD
- æœ€å¤§è®¾å¤‡: 200-400 å°
```

**èŠ‚ç‚¹åˆ†å¸ƒ**:
- è‡³å°‘ 2 ä¸ªèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨ï¼‰
- å»ºè®® 3-5 ä¸ªèŠ‚ç‚¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- å¤§è§„æ¨¡éƒ¨ç½²ï¼š10+ èŠ‚ç‚¹

### 2. æ ‡ç­¾ä½¿ç”¨

**æ¨èæ ‡ç­¾**:
```json
{
  "env": "prod",              // ç¯å¢ƒ: prod/staging/dev
  "region": "us-west",        // åŒºåŸŸ
  "zone": "us-west-1a",       // å¯ç”¨åŒº
  "tier": "high-performance", // æ€§èƒ½ç­‰çº§
  "gpu": "nvidia-rtx3090",    // GPU å‹å·
  "storage-type": "nvme",     // å­˜å‚¨ç±»å‹
  "network": "10gbps"         // ç½‘ç»œå¸¦å®½
}
```

### 3. è°ƒåº¦ç­–ç•¥é€‰æ‹©

**ç”Ÿäº§ç¯å¢ƒ**:
- æ¸¸æˆå¤šå¼€ï¼š`binpack` - èŠ‚çœæˆæœ¬
- åº”ç”¨å•†åº—ï¼š`balanced` - å‡è¡¡è´Ÿè½½
- é«˜å¯ç”¨æœåŠ¡ï¼š`spread` - åˆ†æ•£é£é™©

**å¼€å‘/æµ‹è¯•ç¯å¢ƒ**:
- `balanced` æˆ– `least_loaded`

### 4. ç›‘æ§å’Œå‘Šè­¦

**å…³é”®æŒ‡æ ‡**:
- èŠ‚ç‚¹è´Ÿè½½ > 80%ï¼šå‘Šè­¦ï¼Œè€ƒè™‘æ‰©å®¹
- èŠ‚ç‚¹ç¦»çº¿ï¼šå‘Šè­¦ï¼Œæ£€æŸ¥åŸå› 
- è®¾å¤‡æ•°æ¥è¿‘ä¸Šé™ï¼šé¢„è­¦ï¼Œå‡†å¤‡æ‰©å®¹
- CPU/å†…å­˜ä½¿ç”¨ç‡ > 85%ï¼šå‘Šè­¦

**æ¨èç›‘æ§å·¥å…·**:
- Prometheus + Grafana
- å®šæœŸè°ƒç”¨ `/scheduler/resources/cluster-stats`
- è®¾ç½®è‡ªåŠ¨å‘Šè­¦è§„åˆ™

### 5. æ‰©å®¹æµç¨‹

```bash
# 1. å‡†å¤‡æ–°èŠ‚ç‚¹
# - å®‰è£… Docker
# - é…ç½®ç½‘ç»œ
# - ç¡®ä¿ä¸ç°æœ‰èŠ‚ç‚¹äº’é€š

# 2. æ³¨å†Œæ–°èŠ‚ç‚¹
curl -X POST /scheduler/nodes -d '{...}'

# 3. éªŒè¯èŠ‚ç‚¹çŠ¶æ€
curl /scheduler/nodes/{nodeId}

# 4. è§‚å¯Ÿè´Ÿè½½åˆ†å¸ƒ
curl /scheduler/resources/cluster-stats

# 5. å¦‚éœ€è¦ï¼Œè§¦å‘é‡å¹³è¡¡
curl -X POST /scheduler/rebalance
```

### 6. ç»´æŠ¤æµç¨‹

```bash
# 1. è®¾ç½®æ’ç©ºæ¨¡å¼
curl -X POST /scheduler/nodes/{nodeId}/drain

# 2. ç­‰å¾…æ–°è®¾å¤‡è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹

# 3. è¿ç§»ç°æœ‰è®¾å¤‡ï¼ˆæ‰‹åŠ¨æˆ–è„šæœ¬ï¼‰
# ... è¿ç§»é€»è¾‘

# 4. ç¡®è®¤èŠ‚ç‚¹æ— è®¾å¤‡
curl /scheduler/nodes/{nodeId}

# 5. è®¾ç½®ç»´æŠ¤æ¨¡å¼
curl -X POST /scheduler/nodes/{nodeId}/maintenance -d '{"enable": true}'

# 6. æ‰§è¡Œç»´æŠ¤æ“ä½œ
# ... å‡çº§/é‡å¯/ä¿®å¤

# 7. æ¢å¤åœ¨çº¿
curl -X POST /scheduler/nodes/{nodeId}/maintenance -d '{"enable": false}'
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: èŠ‚ç‚¹æ— æ³•æ³¨å†Œ

**ç—‡çŠ¶**: æ³¨å†ŒèŠ‚ç‚¹è¿”å›é”™è¯¯

**å¯èƒ½åŸå› **:
1. èŠ‚ç‚¹åç§°å·²å­˜åœ¨
2. IP åœ°å€ä¸å¯è¾¾
3. Docker ç«¯å£æœªå¼€æ”¾

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥èŠ‚ç‚¹åç§°
curl /scheduler/nodes | jq '.[] | .name'

# 2. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping 192.168.1.100
telnet 192.168.1.100 2375

# 3. æ£€æŸ¥ Docker é…ç½®
docker -H tcp://192.168.1.100:2375 ps
```

### é—®é¢˜ 2: èŠ‚ç‚¹è‡ªåŠ¨ç¦»çº¿

**ç—‡çŠ¶**: èŠ‚ç‚¹çŠ¶æ€å˜ä¸º `offline`

**å¯èƒ½åŸå› **:
1. ç½‘ç»œé—®é¢˜
2. Docker daemon åœæ­¢
3. èµ„æºç›‘æ§å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥èŠ‚ç‚¹å¿ƒè·³
curl /scheduler/nodes/{nodeId} | jq '.lastHeartbeat, .failedHealthChecks'

# 2. æ‰‹åŠ¨è§¦å‘èµ„æºæ›´æ–°
curl -X POST /scheduler/resources/update/{nodeId}

# 3. æ£€æŸ¥èŠ‚ç‚¹æ—¥å¿—
# ç™»å½•èŠ‚ç‚¹æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—

# 4. é‡æ–°æ³¨å†ŒèŠ‚ç‚¹
# å¦‚æœé—®é¢˜æŒç»­ï¼Œåˆ é™¤å¹¶é‡æ–°æ³¨å†Œ
```

### é—®é¢˜ 3: è°ƒåº¦å¤±è´¥

**ç—‡çŠ¶**: è°ƒåº¦è®¾å¤‡æ—¶è¿”å› "No available nodes"

**å¯èƒ½åŸå› **:
1. æ‰€æœ‰èŠ‚ç‚¹ç¦»çº¿
2. èµ„æºä¸è¶³
3. æ±¡ç‚¹é™åˆ¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥åœ¨çº¿èŠ‚ç‚¹
curl /scheduler/nodes?status=online

# 2. æ£€æŸ¥é›†ç¾¤èµ„æº
curl /scheduler/resources/cluster-stats

# 3. æ£€æŸ¥æ±¡ç‚¹é…ç½®
curl /scheduler/nodes/{nodeId} | jq '.taints'

# 4. é™ä½èµ„æºéœ€æ±‚æˆ–æ‰©å®¹
```

### é—®é¢˜ 4: è´Ÿè½½ä¸å‡è¡¡

**ç—‡çŠ¶**: æŸäº›èŠ‚ç‚¹è´Ÿè½½å¾ˆé«˜ï¼Œå…¶ä»–èŠ‚ç‚¹ç©ºé—²

**å¯èƒ½åŸå› **:
1. è°ƒåº¦ç­–ç•¥ä¸åˆé€‚
2. è®¾å¤‡æœªé‡å¹³è¡¡
3. èŠ‚ç‚¹ä¼˜å…ˆçº§è®¾ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥å½“å‰ç­–ç•¥
curl /scheduler/stats | jq '.strategy'

# 2. æ›´æ”¹ç­–ç•¥ä¸º balanced
curl -X POST /scheduler/strategy -d '{"strategy": "balanced"}'

# 3. è§¦å‘é›†ç¾¤é‡å¹³è¡¡
curl -X POST /scheduler/rebalance

# 4. æ ¹æ®è¿ç§»è®¡åˆ’æ‰‹åŠ¨è¿ç§»è®¾å¤‡
```

### é—®é¢˜ 5: èµ„æºç›‘æ§æ•°æ®ä¸å‡†ç¡®

**ç—‡çŠ¶**: æ˜¾ç¤ºçš„èµ„æºä½¿ç”¨ä¸å®é™…ä¸ç¬¦

**å¯èƒ½åŸå› **:
1. ç›‘æ§ä»»åŠ¡å¤±è´¥
2. è®¾å¤‡æœªæ­£ç¡®æ›´æ–°ç»Ÿè®¡
3. æ•°æ®åº“åŒæ­¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ‰‹åŠ¨è§¦å‘èµ„æºæ›´æ–°
curl -X POST /scheduler/resources/update/{nodeId}

# 2. æ£€æŸ¥è®¾å¤‡çŠ¶æ€
curl /devices | jq '.[] | select(.status == "running") | .id'

# 3. é‡å¯è°ƒåº¦æœåŠ¡
# å®šæ—¶ä»»åŠ¡ä¼šé‡æ–°æ‰§è¡Œ
```

---

## API å‚è€ƒ

### èŠ‚ç‚¹ç®¡ç† API (14ä¸ª)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | /scheduler/nodes | æ³¨å†ŒèŠ‚ç‚¹ |
| GET | /scheduler/nodes | è·å–èŠ‚ç‚¹åˆ—è¡¨ |
| GET | /scheduler/nodes/:id | è·å–èŠ‚ç‚¹è¯¦æƒ… |
| PUT | /scheduler/nodes/:id | æ›´æ–°èŠ‚ç‚¹ |
| DELETE | /scheduler/nodes/:id | æ³¨é”€èŠ‚ç‚¹ |
| POST | /scheduler/nodes/:id/maintenance | ç»´æŠ¤æ¨¡å¼ |
| POST | /scheduler/nodes/:id/drain | æ’ç©ºèŠ‚ç‚¹ |
| POST | /scheduler/nodes/:id/taints | æ·»åŠ æ±¡ç‚¹ |
| DELETE | /scheduler/nodes/:id/taints/:key | åˆ é™¤æ±¡ç‚¹ |
| PUT | /scheduler/nodes/:id/labels | æ›´æ–°æ ‡ç­¾ |
| DELETE | /scheduler/nodes/:id/labels/:key | åˆ é™¤æ ‡ç­¾ |
| GET | /scheduler/nodes/stats/summary | èŠ‚ç‚¹ç»Ÿè®¡ |
| GET | /scheduler/nodes/by-region/:region | æŒ‰åŒºåŸŸæŸ¥è¯¢ |
| GET | /scheduler/nodes/by-label | æŒ‰æ ‡ç­¾æŸ¥è¯¢ |

### è°ƒåº¦å™¨ API (5ä¸ª)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | /scheduler/schedule | è°ƒåº¦è®¾å¤‡ |
| POST | /scheduler/schedule/batch | æ‰¹é‡è°ƒåº¦ |
| POST | /scheduler/strategy | è®¾ç½®ç­–ç•¥ |
| GET | /scheduler/stats | è°ƒåº¦ç»Ÿè®¡ |
| POST | /scheduler/rebalance | é›†ç¾¤é‡å¹³è¡¡ |

### èµ„æºç›‘æ§ API (3ä¸ª)

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | /scheduler/resources/update/:nodeId | æ›´æ–°èŠ‚ç‚¹èµ„æº |
| GET | /scheduler/resources/cluster-stats | é›†ç¾¤ç»Ÿè®¡ |
| GET | /scheduler/resources/local-node-info | æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯ |

---

## æ€»ç»“

èµ„æºè°ƒåº¦ç³»ç»Ÿæä¾›äº†ä¼ä¸šçº§çš„å¤šèŠ‚ç‚¹ç®¡ç†èƒ½åŠ›ï¼š

âœ… **æ™ºèƒ½è°ƒåº¦**: 4ç§ç­–ç•¥é€‚åº”ä¸åŒåœºæ™¯
âœ… **è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨åˆ†é…è®¾å¤‡åˆ°æœ€ä¼˜èŠ‚ç‚¹
âœ… **é«˜å¯ç”¨**: èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨è½¬ç§»
âœ… **çµæ´»æ‰©å±•**: åŠ¨æ€æ·»åŠ /ç§»é™¤èŠ‚ç‚¹
âœ… **ç²¾ç»†æ§åˆ¶**: æ ‡ç­¾ã€æ±¡ç‚¹ã€ä¼˜å…ˆçº§å¤šç»´åº¦æ§åˆ¶

**æ¨èéƒ¨ç½²è§„æ¨¡**:
- å°è§„æ¨¡ï¼ˆ<100å°è®¾å¤‡ï¼‰: 2-3ä¸ªèŠ‚ç‚¹
- ä¸­è§„æ¨¡ï¼ˆ100-500å°è®¾å¤‡ï¼‰: 4-6ä¸ªèŠ‚ç‚¹
- å¤§è§„æ¨¡ï¼ˆ500+å°è®¾å¤‡ï¼‰: 10+ä¸ªèŠ‚ç‚¹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-10-20
**ç»´æŠ¤è€…**: Device Service Team
